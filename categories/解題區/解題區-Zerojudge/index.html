<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Category: 解題區 - Zerojudge | Morris&#39; Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="ACMer NEET NCU UVa OJ">
<meta property="og:type" content="website">
<meta property="og:title" content="Morris' Blog">
<meta property="og:url" content="http://morris821028.github.io/categories/解題區/解題區-Zerojudge/">
<meta property="og:site_name" content="Morris' Blog">
<meta property="og:description" content="ACMer NEET NCU UVa OJ">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Morris' Blog">
<meta name="twitter:description" content="ACMer NEET NCU UVa OJ">
<link rel="publisher" href="108158678174364350000">

  
    <link rel="alternative" href="/atom.xml" title="Morris&#39; Blog" type="application/atom+xml">
  
  
    <meta name="google-site-verification" content="5mRgj8NanEMpGZuNfHNJNmH90RgNlrnJXsFlTaKD6Gs" />
  
  
    <link rel="shortcut icon" href="/img/f.ico">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <script src="/js/jquery-2.1.0.min.js"></script>
  <link rel="stylesheet" href="/css/style.css" type="text/css">

  
  <!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
  <link rel="stylesheet" href="http://cdn.oesmith.co.uk/morris-0.5.1.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
<script src="http://cdn.oesmith.co.uk/morris-0.5.1.min.js"></script>
</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"><div id="banner-right"></div></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Morris&#39; Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Can you find me ?</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          
            <a class="main-nav-link" href="/"><i class=icon-home title='Home'></i></a>
          
        
          
            <a class="main-nav-link" href="/about"><i class=icon-user title='About'></i></a>
          
        
          
            <a class="main-nav-link" href="/archives"><i class=icon-archive title='Archives'></i></a>
          
        
          
            <a class="main-nav-link" href="/tags"><i class=icon-tags title='Tags'></i></a>
          
        
          
            <a class="main-nav-link" href="/picture"><i class=icon-camera title='Pictures'></i></a>
          
        
          
            <a class="main-nav-link" href="/works"><i class=icon-trophy title='Works'></i></a>
          
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><input type="submit" value="&#xF002;" class="search-form-submit"><input type="hidden" name="q" value="site:http://morris821028.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        
          <section id="main">
  
    <article id="post-zj-b446" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/07/15/zj-b446/" class="article-date">
  <time datetime="2015-07-15T11:39:38.000Z" itemprop="datePublished">Jul 15 2015</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>►<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/07/15/zj-b446/">b446. 搜索美學 史蒂芙的煩惱</a>
    </h1>
  

      </header>
        
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/07/15/zj-b446/" data-id="ji8a9lvsztmoadh3" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/07/15/zj-b446/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CDQ-分治/">CDQ 分治</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kd-tree/">kd-tree</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/在線處理/">在線處理</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/替罪羊樹/">替罪羊樹</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/樹套樹/">樹套樹</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/離線處理/">離線處理</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem">Problem</h2>
<h3 id="背景">背景</h3>
<p>動畫 遊戲人生《No Game No Life》中，史蒂芙 (Stephanie Dola) 常常被欺負，儘管她以學院第一畢業，對於遊戲一竅不通的她在這個世界常常被欺負。現在就交給你來幫幫她。</p>
<h3 id="問題描述">問題描述</h3>
<p>兩個人輪流在一個大棋盤上下棋，每一步棋的得分根據這一步棋與最鄰近的敵方棋子的曼哈頓距離。</p>
<p>對於兩個點 $p, q$ 座標 $(p_x, p_y), (q_x, q_y)$，曼哈頓距離 (Manhattan distance) 為 $|p_x - q_x| + |p_y - q_y|$。</p>
<h2 id="Sample_Input">Sample Input</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">3</div><div class="line">1 1</div><div class="line">5 5</div><div class="line">4 4</div><div class="line">3 2</div><div class="line">2 4</div><div class="line">2 3</div></pre></td></tr></table></figure>

<h2 id="Sample_Output">Sample Output</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">8</div><div class="line">2</div><div class="line">3</div><div class="line">3</div><div class="line">1</div></pre></td></tr></table></figure>

<h2 id="Solution">Solution</h2>
<p>把鄰近搜索問題做個總結，普遍處理的是靜態資料跟單一詢問，而在最近餐館那一題已經用 KD-tree 處理過 KNN 問題。這一題是採用動態插入和詢問以及數學性質較強的曼哈頓距離，離線處理也是個選擇。</p>
<p>此問題限制在 $n = 50000$ 的情況下，進行測試討論，除了分桶、方格法外，探討三種思路：</p>
<ul>
<li>Dynamic KD-tree 利用替罪羊樹的概念完成，看著卦長的代碼以及卡車口述概要，終於敲敲打打拼湊起來，掛上啟發式的搭配具有不錯的成效。空間複雜度 $O(n)$，時間複雜度 $O(\sqrt{n})$，速度是暴力法 $O(n^2)$ 二十倍左右。</li>
<li>Segment tree + 平衡樹，空間複雜度 $O(n \log n)$，時間複雜度 $O(\log^3 n)$，使用座標轉換將菱形轉換成正方形，套上二分邊長去查找區域內部是否有點。由於 $n$ 的緣故，速度比 Dynamic KD-tree 慢上許多，若用暴力法 $O(n^2)$ 只快兩倍之多。實作測試提供者 liouzhou_101。</li>
<li>離線處理 CDQ 分治，空間複雜度 $O(n)$，總時間複雜度 $O(n \log^2 n)$，採用思路為曼哈頓距離切割成四個象限進行極值查找。比暴力法快十倍所右。</li>
</ul>
<p>前兩個作法比較裸，在此特別補充 CDQ 分治，曼哈頓距離可以考慮成四個象限，詢問 $(x, y)$ 的最鄰近點，首先考慮左下角 $(x’, y’)$，亦即 $x’ \le x, \; y’ \le y$，則曼哈頓距離 $dist = (x - x’) + (y - y’) = (x + y) - (x’ + y’)$，明顯地求最近距離要讓 $x’ + y’$ 最大化。同理其他象限。</p>
<p>為了解決這詢問，套用 CDQ 分治，按照 $x$ 座標排序，接著二分操作順序，切割操作 $[l, mid], [mid+1, r]$，在左右兩塊仍然按照 $x$ 排序。單獨看 $[mid+1, r]$ 的操作會受 $[l, mid]$ 和自己本身影響，對於前者而言，採用歸併排序那樣，按照 $x$ 座標慢慢合併 (概念上)，合併過程套用 Binary indexed tree 進行極值查找。對於後者，就進行遞迴求解，明顯地 $[l, mid]$ 只會受 $[l, mid]$ 影響。</p>
<p>CDQ 分治的概要，按照其中一個關鍵排序，接著二分操作順序進行分置處理。國外是有論文在描述這個 Online to Offline 的算法，CDQ 命名就是人名，會給國外看笑話吧。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function">sort</span>(key)</div><div class="line"></div><div class="line"><span class="function">solve</span>(l, r)</div><div class="line">	<span class="function">solve</span>(l, mid)</div><div class="line">	<span class="function">process</span>(<span class="attr_selector">[l, mid]</span>, <span class="attr_selector">[mid+1, r]</span>)</div><div class="line">	<span class="function">solve</span>(mid+1, r)</div></pre></td></tr></table></figure>

<p>備註「欸欸，加上悔棋的話，是不是持久化 kd-tree」</p>
<h3 id="實作探討">實作探討</h3>
<p>關於 kd-tree 實作細節探討，與通常會犯的錯誤，關係到速度有常數差異。</p>
<p>在 <code>closest()</code> 中，常犯的錯誤是 <strong> 探索順序 </strong>，盡可能先靠近，啟發式才能更加快速，別像我打出錯誤的搜索順序如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function_or_atom">if</span> (<span class="function_or_atom">x</span>.<span class="function_or_atom">d</span>[<span class="function_or_atom">k</span>] &lt;= <span class="function_or_atom">u</span><span class="arrow">-&gt;</span><span class="function_or_atom">pid</span>.<span class="function_or_atom">d</span>[<span class="function_or_atom">k</span>]) {    		</div><div class="line">	<span class="function_or_atom">closest</span>(<span class="function_or_atom">u</span><span class="arrow">-&gt;</span><span class="function_or_atom">lson</span>, (<span class="function_or_atom">k</span>+<span class="number">1</span>)<span class="comment">%kD, x, h, mndist);</span></div><div class="line">	<span class="function_or_atom">h</span>[<span class="function_or_atom">k</span>] = <span class="function_or_atom">abs</span>(<span class="function_or_atom">x</span>.<span class="function_or_atom">d</span>[<span class="function_or_atom">k</span>] - <span class="function_or_atom">u</span><span class="arrow">-&gt;</span><span class="function_or_atom">pid</span>.<span class="function_or_atom">d</span>[<span class="function_or_atom">k</span>]);</div><div class="line">	<span class="function_or_atom">closest</span>(<span class="function_or_atom">u</span><span class="arrow">-&gt;</span><span class="function_or_atom">rson</span>, (<span class="function_or_atom">k</span>+<span class="number">1</span>)<span class="comment">%kD, x, h, mndist);</span></div><div class="line">	<span class="function_or_atom">h</span>[<span class="function_or_atom">k</span>] = <span class="function_or_atom">old</span>;</div><div class="line">} <span class="function_or_atom">else</span> {</div><div class="line">	<span class="function_or_atom">h</span>[<span class="function_or_atom">k</span>] = <span class="function_or_atom">abs</span>(<span class="function_or_atom">x</span>.<span class="function_or_atom">d</span>[<span class="function_or_atom">k</span>] - <span class="function_or_atom">u</span><span class="arrow">-&gt;</span><span class="function_or_atom">pid</span>.<span class="function_or_atom">d</span>[<span class="function_or_atom">k</span>]);</div><div class="line">	<span class="function_or_atom">closest</span>(<span class="function_or_atom">u</span><span class="arrow">-&gt;</span><span class="function_or_atom">lson</span>, (<span class="function_or_atom">k</span>+<span class="number">1</span>)<span class="comment">%kD, x, h, mndist);</span></div><div class="line">	<span class="function_or_atom">h</span>[<span class="function_or_atom">k</span>] = <span class="function_or_atom">old</span>;</div><div class="line">	<span class="function_or_atom">closest</span>(<span class="function_or_atom">u</span><span class="arrow">-&gt;</span><span class="function_or_atom">rson</span>, (<span class="function_or_atom">k</span>+<span class="number">1</span>)<span class="comment">%kD, x, h, mndist);</span></div><div class="line">}</div></pre></td></tr></table></figure>

<p>實作的順序應該如下，別總是先探訪左子樹、在去探訪右子樹，kd-tree 必須注意順序。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function_or_atom">if</span> (<span class="function_or_atom">x</span>.<span class="function_or_atom">d</span>[<span class="function_or_atom">k</span>] &lt;= <span class="function_or_atom">u</span><span class="arrow">-&gt;</span><span class="function_or_atom">pid</span>.<span class="function_or_atom">d</span>[<span class="function_or_atom">k</span>]) {    		</div><div class="line">	<span class="function_or_atom">closest</span>(<span class="function_or_atom">u</span><span class="arrow">-&gt;</span><span class="function_or_atom">lson</span>, (<span class="function_or_atom">k</span>+<span class="number">1</span>)<span class="comment">%kD, x, h, mndist);</span></div><div class="line">	<span class="function_or_atom">h</span>[<span class="function_or_atom">k</span>] = <span class="function_or_atom">abs</span>(<span class="function_or_atom">x</span>.<span class="function_or_atom">d</span>[<span class="function_or_atom">k</span>] - <span class="function_or_atom">u</span><span class="arrow">-&gt;</span><span class="function_or_atom">pid</span>.<span class="function_or_atom">d</span>[<span class="function_or_atom">k</span>]);</div><div class="line">	<span class="function_or_atom">closest</span>(<span class="function_or_atom">u</span><span class="arrow">-&gt;</span><span class="function_or_atom">rson</span>, (<span class="function_or_atom">k</span>+<span class="number">1</span>)<span class="comment">%kD, x, h, mndist);</span></div><div class="line">	<span class="function_or_atom">h</span>[<span class="function_or_atom">k</span>] = <span class="function_or_atom">old</span>;</div><div class="line">} <span class="function_or_atom">else</span> {</div><div class="line">	<span class="function_or_atom">closest</span>(<span class="function_or_atom">u</span><span class="arrow">-&gt;</span><span class="function_or_atom">rson</span>, (<span class="function_or_atom">k</span>+<span class="number">1</span>)<span class="comment">%kD, x, h, mndist);</span></div><div class="line">	<span class="function_or_atom">h</span>[<span class="function_or_atom">k</span>] = <span class="function_or_atom">abs</span>(<span class="function_or_atom">x</span>.<span class="function_or_atom">d</span>[<span class="function_or_atom">k</span>] - <span class="function_or_atom">u</span><span class="arrow">-&gt;</span><span class="function_or_atom">pid</span>.<span class="function_or_atom">d</span>[<span class="function_or_atom">k</span>]);</div><div class="line">	<span class="function_or_atom">closest</span>(<span class="function_or_atom">u</span><span class="arrow">-&gt;</span><span class="function_or_atom">lson</span>, (<span class="function_or_atom">k</span>+<span class="number">1</span>)<span class="comment">%kD, x, h, mndist);</span></div><div class="line">	<span class="function_or_atom">h</span>[<span class="function_or_atom">k</span>] = <span class="function_or_atom">old</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>假設資料大小 <code>sizeof(dim_element)</code> 很大，通常會利用指針陣列來進行排序，這樣可以降低搬運大型資料複製時間，但奇怪的是由於指針陣列佔有一定空間，索引資料時又會佔據一段空間，估計是快取方面出了點問題 (或者是我寫不好)，導致直接搬運資料是來得比較快速，這個修改在 b348. 最近餐館 也有進行測試，速度有提升。</p>
<p>接著可以藉由函數參數少量，來拉快程式在堆疊參數所需要的時間，在節點內部宣告採用維度 <code>d</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Node</span> </span>{</div><div class="line">    Node *lson, *rson;</div><div class="line">    Point pid; </div><div class="line">    int size, d;</div><div class="line">};</div></pre></td></tr></table></figure>

<p>這個修改造成詢問時，不僅僅在走訪傳遞參數少了一個，還少 <code>k+1</code> 的計算。測試結果中，光靠這一點速度沒有明顯提升。kd tree 還有一個靠臉吃飯的邊界分割，要是相同時分左分右，這一點是最痛苦的，在此就不去討論，當然可以利用隨機擾動來解決這問題。</p>
<p>至於要使用 <code>sort()</code> 進行 $O(n \log n)$、還是使用 <code>nth_element()</code> 的 $O(n)$ 找到中位數，根據兩題的測試，由於 $n$ 都不大，照理來講 <code>nth_element()</code> 快於 <code>sort()</code>，但根據實際測試於 liouzhou_101 的代碼，<code>sort()</code> 的速度會比較快，其一是運氣、其二是未知情況。就從以下代碼中，差異並不明顯。</p>
<h3 id="Dynamic_Kd_tree">Dynamic Kd tree</h3>
<p>沒有提供垃圾回收，靠內存持運作，要是 RE 就放大一點。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;bits/stdc++.h&gt;</span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">131072</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXM = <span class="number">50005</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXD = <span class="number">2</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> INF = INT_MAX;</div><div class="line"><span class="keyword">const</span> <span class="keyword">double</span> ALPHA = <span class="number">0.75</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">double</span> LOG_ALPHA = log2(<span class="number">1.0</span> / ALPHA);</div><div class="line"><span class="keyword">class</span> KD_TREE {</div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="keyword">struct</span> Point {</div><div class="line">    	<span class="keyword">static</span> <span class="keyword">int</span> kD;</div><div class="line">        <span class="keyword">int</span> d[MAXD], pid;</div><div class="line">        <span class="keyword">int</span> dist(Point &amp;x) {</div><div class="line">        	<span class="keyword">int</span> ret = <span class="number">0</span>;</div><div class="line">        	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; kD; i++)</div><div class="line">        		ret += <span class="built_in">abs</span>(d[i] - x.d[i]);</div><div class="line">        	<span class="keyword">return</span> ret;</div><div class="line">        }</div><div class="line">        <span class="keyword">void</span> read(<span class="keyword">int</span> id = <span class="number">0</span>) {</div><div class="line">        	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; kD; i++)</div><div class="line">        		<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;d[i]);</div><div class="line">        	pid = id;</div><div class="line">        }    	</div><div class="line">		<span class="keyword">static</span> <span class="keyword">int</span> sortIdx;</div><div class="line">        <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(<span class="keyword">const</span> Point &amp;x) <span class="keyword">const</span> {</div><div class="line">            <span class="keyword">return</span> d[sortIdx] &lt; x.d[sortIdx];</div><div class="line">        }</div><div class="line">    };</div><div class="line">    <span class="keyword">struct</span> Node {</div><div class="line">        Node *lson, *rson;</div><div class="line">        Point pid; </div><div class="line">        <span class="keyword">int</span> size;</div><div class="line">        Node() {</div><div class="line">        	lson = rson = NULL;</div><div class="line">        	size = <span class="number">1</span>;</div><div class="line">        }</div><div class="line">        <span class="keyword">void</span> update() {</div><div class="line">        	size = <span class="number">1</span>;</div><div class="line">        	<span class="keyword">if</span> (lson)	size += lson-&gt;size;</div><div class="line">        	<span class="keyword">if</span> (rson)	size += rson-&gt;size;</div><div class="line">        }</div><div class="line">    } nodes[MAXN];</div><div class="line">    Node *root;</div><div class="line">    Point A[MAXM];</div><div class="line">    <span class="keyword">int</span> bufsize, size, kD;</div><div class="line">    <span class="keyword">void</span> init(<span class="keyword">int</span> kd) {</div><div class="line">    	size = bufsize = <span class="number">0</span>;</div><div class="line">    	root = NULL;</div><div class="line">    	Point::sortIdx = <span class="number">0</span>;</div><div class="line">		Point::kD = kD = kd;</div><div class="line">	}</div><div class="line">    <span class="keyword">void</span> insert(Point x) {</div><div class="line">    	insert(root, <span class="number">0</span>, x, log2int(size) / LOG_ALPHA);</div><div class="line">    }</div><div class="line">	<span class="keyword">int</span> closest(Point x) {</div><div class="line">    	<span class="keyword">int</span> mndist = INF, h[MAXD] = {};</div><div class="line">    	closest(root, <span class="number">0</span>, x, h, mndist);</div><div class="line">    	<span class="keyword">return</span> mndist;</div><div class="line">    }</div><div class="line"><span class="keyword">private</span>:</div><div class="line">	<span class="keyword">int</span> log2int(<span class="keyword">int</span> x){</div><div class="line">		<span class="keyword">return</span> __builtin_clz((<span class="keyword">int</span>)<span class="number">1</span>)-__builtin_clz(x);</div><div class="line">    }</div><div class="line">    <span class="keyword">inline</span> <span class="keyword">int</span> isbad(Node *u) {</div><div class="line">    	<span class="keyword">if</span> (u-&gt;lson &amp;&amp; u-&gt;lson-&gt;size &gt; u-&gt;size * ALPHA)</div><div class="line">    		<span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">    	<span class="keyword">if</span> (u-&gt;rson &amp;&amp; u-&gt;rson-&gt;size &gt; u-&gt;size * ALPHA)</div><div class="line">    		<span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">    	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    }    </div><div class="line">	Node* newNode()  {</div><div class="line">    	Node *ret = &amp;nodes[bufsize++];</div><div class="line">    	*ret = Node();</div><div class="line">    	<span class="keyword">return</span> ret;</div><div class="line">    }</div><div class="line">    Node* build(<span class="keyword">int</span> k, <span class="keyword">int</span> l, <span class="keyword">int</span> r) {</div><div class="line">    	<span class="keyword">if</span> (l &gt; r)	<span class="keyword">return</span> NULL;</div><div class="line">    	<span class="keyword">if</span> (k == kD)	k = <span class="number">0</span>;</div><div class="line">    	Node *ret = newNode();</div><div class="line">    	<span class="keyword">int</span> mid = (l + r)&gt;&gt;<span class="number">1</span>;</div><div class="line">    	Point::sortIdx = k;</div><div class="line">    	sort(A+l, A+r+<span class="number">1</span>);</div><div class="line">    	ret-&gt;pid = A[mid];</div><div class="line">		ret-&gt;lson = build(k+<span class="number">1</span>, l, mid-<span class="number">1</span>);</div><div class="line">		ret-&gt;rson = build(k+<span class="number">1</span>, mid+<span class="number">1</span>, r);</div><div class="line">    	ret-&gt;update();</div><div class="line">    	<span class="keyword">return</span> ret;</div><div class="line">    }</div><div class="line">    <span class="keyword">void</span> flatten(Node *u, Point* &amp;buf) {</div><div class="line">    	<span class="keyword">if</span> (u == NULL)	<span class="keyword">return</span> ;</div><div class="line">    	flatten(u-&gt;lson, buf);</div><div class="line">    	*buf = u-&gt;pid, buf++;</div><div class="line">    	flatten(u-&gt;rson, buf);</div><div class="line">    }</div><div class="line">    <span class="keyword">bool</span> insert(Node* &amp;u, <span class="keyword">int</span> k, Point &amp;x, <span class="keyword">int</span> dep) {</div><div class="line">    	<span class="keyword">if</span> (u == NULL) {</div><div class="line">    		u = newNode(), u-&gt;pid = x;</div><div class="line">    		<span class="keyword">return</span> dep &lt;= <span class="number">0</span>;</div><div class="line">    	}</div><div class="line">    	u-&gt;size++;</div><div class="line">    	<span class="keyword">int</span> t = <span class="number">0</span>;</div><div class="line">    	<span class="keyword">if</span> (x.d[k] &lt;= u-&gt;pid.d[k])</div><div class="line">    		t = insert(u-&gt;lson, (k+<span class="number">1</span>)%kD, x, dep-<span class="number">1</span>);</div><div class="line">    	<span class="keyword">else</span></div><div class="line">    		t = insert(u-&gt;rson, (k+<span class="number">1</span>)%kD, x, dep-<span class="number">1</span>);</div><div class="line">    	<span class="keyword">if</span> (t &amp;&amp; !isbad(u))</div><div class="line">    		<span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">    	<span class="keyword">if</span> (t) {</div><div class="line">    		Point *ptr = &amp;A[<span class="number">0</span>];</div><div class="line">    		flatten(u, ptr);</div><div class="line">    		u = build(k, <span class="number">0</span>, u-&gt;size-<span class="number">1</span>);</div><div class="line">    	}</div><div class="line">    	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    }</div><div class="line">    <span class="keyword">int</span> heuristic(<span class="keyword">int</span> h[]) {</div><div class="line">    	<span class="keyword">int</span> ret = <span class="number">0</span>;</div><div class="line">    	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; kD; i++)</div><div class="line">    		ret += h[i];</div><div class="line">    	<span class="keyword">return</span> ret;</div><div class="line">    }</div><div class="line">    <span class="keyword">void</span> closest(Node *u, <span class="keyword">int</span> k, Point &amp;x, <span class="keyword">int</span> h[], <span class="keyword">int</span> &amp;mndist) {</div><div class="line">    	<span class="keyword">if</span> (u == NULL || heuristic(h) &gt;= mndist)</div><div class="line">    		<span class="keyword">return</span> ;</div><div class="line">    	<span class="keyword">int</span> dist = u-&gt;pid.dist(x), old;</div><div class="line">    	mndist = min(mndist, dist), old = h[k];</div><div class="line">    	<span class="keyword">if</span> (x.d[k] &lt;= u-&gt;pid.d[k]) {    		</div><div class="line">			closest(u-&gt;lson, (k+<span class="number">1</span>)%kD, x, h, mndist);</div><div class="line">			h[k] = <span class="built_in">abs</span>(x.d[k] - u-&gt;pid.d[k]);</div><div class="line">			closest(u-&gt;rson, (k+<span class="number">1</span>)%kD, x, h, mndist);</div><div class="line">			h[k] = old;</div><div class="line">    	} <span class="keyword">else</span> {</div><div class="line">    		closest(u-&gt;rson, (k+<span class="number">1</span>)%kD, x, h, mndist);</div><div class="line">			h[k] = <span class="built_in">abs</span>(x.d[k] - u-&gt;pid.d[k]);</div><div class="line">			closest(u-&gt;lson, (k+<span class="number">1</span>)%kD, x, h, mndist);</div><div class="line">			h[k] = old;</div><div class="line">    	}</div><div class="line">    }</div><div class="line">} A, B;</div><div class="line"><span class="keyword">int</span> KD_TREE::Point::sortIdx = <span class="number">0</span>, KD_TREE::Point::kD = <span class="number">2</span>;</div><div class="line"></div><div class="line"><span class="keyword">int</span> main() {</div><div class="line">	<span class="keyword">int</span> N;</div><div class="line">	KD_TREE::Point pt;</div><div class="line">	<span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;N) == <span class="number">1</span>) {</div><div class="line">		A.init(<span class="number">2</span>), B.init(<span class="number">2</span>);</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) {</div><div class="line">			pt.read(i);</div><div class="line">			<span class="keyword">if</span> (i)	<span class="built_in">printf</span>(<span class="string">"%d\n"</span>, B.closest(pt));</div><div class="line">			A.insert(pt);</div><div class="line">			pt.read(i);</div><div class="line">			<span class="built_in">printf</span>(<span class="string">"%d\n"</span>, A.closest(pt));</div><div class="line">			B.insert(pt);</div><div class="line">		}</div><div class="line">	}</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure>


<h3 id="CDQ_分治">CDQ 分治</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div></pre></td><td class="code"><pre><div class="line">#include &lt;bits/stdc++.h&gt;</div><div class="line">using <span class="keyword">namespace</span> std;</div><div class="line"></div><div class="line">const <span class="keyword">int</span> MAXQ = <span class="number">131072</span>;</div><div class="line">const <span class="keyword">int</span> MAXN = <span class="number">40000</span>;</div><div class="line">const <span class="keyword">int</span> INF = INT_MAX;</div><div class="line">class Offline {</div><div class="line">public:</div><div class="line">	struct Point {</div><div class="line">		<span class="keyword">int</span> x, y;</div><div class="line">		Point(<span class="keyword">int</span> a = <span class="number">0</span>, <span class="keyword">int</span> b = <span class="number">0</span>):</div><div class="line">			x(a), y(b) {}</div><div class="line">		bool operator&lt;(const Point &amp;a) const {</div><div class="line">			<span class="keyword">return</span> x &lt; a.x || (x == a.x &amp;&amp; y &lt; a.y);</div><div class="line">		}</div><div class="line">		void read() {</div><div class="line">			scanf(<span class="string">"%d %d"</span>, &amp;x, &amp;y);</div><div class="line">			x++, y++;</div><div class="line">		}</div><div class="line">	};</div><div class="line">	struct Event {</div><div class="line">		Point p;</div><div class="line">		<span class="keyword">int</span> qtype, qid;</div><div class="line">		Event(<span class="keyword">int</span> a = <span class="number">0</span>, <span class="keyword">int</span> b = <span class="number">0</span>, Point c = Point()):</div><div class="line">			qtype(a), qid(b), p(c) {}</div><div class="line">		bool operator&lt;(const Event &amp;e) const {</div><div class="line">			<span class="keyword">if</span> (p.x != e.p.x)	<span class="keyword">return</span> p.x &lt; e.p.x;</div><div class="line">			<span class="keyword">return</span> qid &lt; e.qid;</div><div class="line">		}</div><div class="line">	};</div><div class="line">	<span class="keyword">vector</span>&lt;Event&gt; <span class="keyword">event</span>;</div><div class="line">	<span class="keyword">int</span> ret[MAXQ], N;</div><div class="line">	void init(<span class="keyword">int</span> n) {</div><div class="line">		<span class="keyword">event</span>.<span class="keyword">clear</span>();</div><div class="line">		N = n; </div><div class="line">	}</div><div class="line">	void addEvent(<span class="keyword">int</span> qtype, <span class="keyword">int</span> qid, Point x) {</div><div class="line">		<span class="keyword">event</span>.push_back(Event(qtype, qid, x));</div><div class="line">	}</div><div class="line">	void run() {</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">event</span>.<span class="keyword">size</span>(); i++)</div><div class="line">			ret[i] = <span class="number">0x3f3f3f3f</span>;		</div><div class="line">		cases = <span class="number">0</span>;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= N; i++)</div><div class="line">			used[i] = <span class="number">0</span>;		</div><div class="line">		<span class="keyword">sort</span>(<span class="keyword">event</span>.begin(), <span class="keyword">event</span>.end());</div><div class="line">		CDQ(<span class="number">0</span>, <span class="keyword">event</span>.<span class="keyword">size</span>()-<span class="number">1</span>);</div><div class="line">	}</div><div class="line">private:</div><div class="line">	Event ebuf[MAXQ];</div><div class="line">	<span class="keyword">int</span> BIT[MAXN], used[MAXN];</div><div class="line">	<span class="keyword">int</span> cases = <span class="number">0</span>;</div><div class="line">	void modify(<span class="keyword">int</span> x, <span class="keyword">int</span> val, <span class="keyword">int</span> dir) {</div><div class="line">		<span class="keyword">for</span> (; x &amp;&amp; x &lt;= N; x += (x&amp;(-x)) * dir) {</div><div class="line">			<span class="keyword">if</span> (used[x] != cases)</div><div class="line">				BIT[x] = -<span class="number">0x3f3f3f3f</span>, used[x] = cases;</div><div class="line">			BIT[x] = <span class="keyword">max</span>(BIT[x], val);</div><div class="line">		}</div><div class="line">	}</div><div class="line">	<span class="keyword">int</span> query(<span class="keyword">int</span> x, <span class="keyword">int</span> dir) {</div><div class="line">		<span class="keyword">int</span> ret = -<span class="number">0x3f3f3f3f</span>;</div><div class="line">		<span class="keyword">for</span> (; x &amp;&amp; x &lt;= N; x += (x&amp;(-x)) * dir) {</div><div class="line">			<span class="keyword">if</span> (used[x] == cases)</div><div class="line">				ret = <span class="keyword">max</span>(ret, BIT[x]);</div><div class="line">		}</div><div class="line">		<span class="keyword">return</span> ret;</div><div class="line">	}</div><div class="line">	void merge(<span class="keyword">int</span> l, <span class="keyword">int</span> mid, <span class="keyword">int</span> r) {</div><div class="line">		cases++;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = mid+<span class="number">1</span>, j = l; i &lt;= r; i++) {</div><div class="line">			<span class="keyword">if</span> (<span class="keyword">event</span>[i].qtype == <span class="number">0</span>) {</div><div class="line">				<span class="keyword">for</span> (; j &lt;= mid &amp;&amp; <span class="keyword">event</span>[j].p.x &lt;= <span class="keyword">event</span>[i].p.x; j++) {</div><div class="line">					<span class="keyword">if</span> (<span class="keyword">event</span>[j].qtype == <span class="number">1</span>) </div><div class="line">						modify(<span class="keyword">event</span>[j].p.y, <span class="keyword">event</span>[j].p.x+<span class="keyword">event</span>[j].p.y, <span class="number">1</span>);</div><div class="line">				} </div><div class="line">				ret[<span class="keyword">event</span>[i].qid] = <span class="keyword">min</span>(ret[<span class="keyword">event</span>[i].qid], <span class="keyword">event</span>[i].p.x+<span class="keyword">event</span>[i].p.y-query(<span class="keyword">event</span>[i].p.y, -<span class="number">1</span>));</div><div class="line">			}</div><div class="line">		}</div><div class="line">		cases++;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = mid+<span class="number">1</span>, j = l; i &lt;= r; i++) {</div><div class="line">			<span class="keyword">if</span> (<span class="keyword">event</span>[i].qtype == <span class="number">0</span>) {</div><div class="line">				<span class="keyword">for</span> (; j &lt;= mid &amp;&amp; <span class="keyword">event</span>[j].p.x &lt;= <span class="keyword">event</span>[i].p.x; j++) {</div><div class="line">					<span class="keyword">if</span> (<span class="keyword">event</span>[j].qtype == <span class="number">1</span>)</div><div class="line">						modify(<span class="keyword">event</span>[j].p.y, <span class="keyword">event</span>[j].p.x-<span class="keyword">event</span>[j].p.y, -<span class="number">1</span>);</div><div class="line">				} </div><div class="line">				ret[<span class="keyword">event</span>[i].qid] = <span class="keyword">min</span>(ret[<span class="keyword">event</span>[i].qid], <span class="keyword">event</span>[i].p.x-<span class="keyword">event</span>[i].p.y-query(<span class="keyword">event</span>[i].p.y, <span class="number">1</span>));</div><div class="line">			}</div><div class="line">		}</div><div class="line">		cases++;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = r, j = mid; i &gt; mid; i--) {</div><div class="line">			<span class="keyword">if</span> (<span class="keyword">event</span>[i].qtype == <span class="number">0</span>) {</div><div class="line">				<span class="keyword">for</span> (; j &gt;= l &amp;&amp; <span class="keyword">event</span>[j].p.x &gt;= <span class="keyword">event</span>[i].p.x; j--) {</div><div class="line">					<span class="keyword">if</span> (<span class="keyword">event</span>[j].qtype == <span class="number">1</span>) </div><div class="line">						modify(<span class="keyword">event</span>[j].p.y, <span class="keyword">event</span>[j].p.y-<span class="keyword">event</span>[j].p.x, <span class="number">1</span>);</div><div class="line">				} </div><div class="line">				ret[<span class="keyword">event</span>[i].qid] = <span class="keyword">min</span>(ret[<span class="keyword">event</span>[i].qid], <span class="keyword">event</span>[i].p.y-<span class="keyword">event</span>[i].p.x-query(<span class="keyword">event</span>[i].p.y, -<span class="number">1</span>));</div><div class="line">			}</div><div class="line">		}</div><div class="line">		cases++;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = r, j = mid; i &gt; mid; i--) {</div><div class="line">			<span class="keyword">if</span> (<span class="keyword">event</span>[i].qtype == <span class="number">0</span>) {</div><div class="line">				<span class="keyword">for</span> (; j &gt;= l &amp;&amp; <span class="keyword">event</span>[j].p.x &gt;= <span class="keyword">event</span>[i].p.x; j--) {</div><div class="line">					<span class="keyword">if</span> (<span class="keyword">event</span>[j].qtype == <span class="number">1</span>) </div><div class="line">						modify(<span class="keyword">event</span>[j].p.y, -<span class="keyword">event</span>[j].p.x-<span class="keyword">event</span>[j].p.y, -<span class="number">1</span>);</div><div class="line">				} </div><div class="line">				ret[<span class="keyword">event</span>[i].qid] = <span class="keyword">min</span>(ret[<span class="keyword">event</span>[i].qid], -<span class="keyword">event</span>[i].p.x-<span class="keyword">event</span>[i].p.y-query(<span class="keyword">event</span>[i].p.y, <span class="number">1</span>));</div><div class="line">			}</div><div class="line">		}</div><div class="line">	}</div><div class="line">	void CDQ(<span class="keyword">int</span> l, <span class="keyword">int</span> r) {</div><div class="line">		<span class="keyword">if</span> (l == r)</div><div class="line">			<span class="keyword">return</span> ;</div><div class="line">		<span class="keyword">int</span> mid = (l + r)/<span class="number">2</span>, lidx, ridx;</div><div class="line">		lidx = l, ridx = mid+<span class="number">1</span>;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = l; i &lt;= r; i++) {</div><div class="line">			<span class="keyword">if</span> (<span class="keyword">event</span>[i].qid &lt;= mid)</div><div class="line">				ebuf[lidx++] = <span class="keyword">event</span>[i];</div><div class="line">			<span class="keyword">else</span></div><div class="line">				ebuf[ridx++] = <span class="keyword">event</span>[i];</div><div class="line">		}</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = l; i &lt;= r; i++)</div><div class="line">			<span class="keyword">event</span>[i] = ebuf[i];</div><div class="line">			</div><div class="line">		CDQ(l, mid);</div><div class="line">		merge(l, mid, r);</div><div class="line">		CDQ(mid+<span class="number">1</span>, r);</div><div class="line">		</div><div class="line">		lidx = l, ridx = mid+<span class="number">1</span>;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = l; i &lt;= r; i++) {</div><div class="line">			<span class="keyword">if</span> ((lidx &lt;= mid &amp;&amp; <span class="keyword">event</span>[lidx] &lt; <span class="keyword">event</span>[ridx]) || ridx &gt; r)</div><div class="line">				ebuf[i]	= <span class="keyword">event</span>[lidx++];</div><div class="line">			<span class="keyword">else</span></div><div class="line">				ebuf[i] = <span class="keyword">event</span>[ridx++];</div><div class="line">		}</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = l; i &lt;= r; i++)</div><div class="line">			<span class="keyword">event</span>[i] = ebuf[i];</div><div class="line">	}</div><div class="line">} A, B;</div><div class="line"></div><div class="line"><span class="keyword">int</span> main() {</div><div class="line">	<span class="keyword">int</span> N;</div><div class="line">	Offline::Point pt;</div><div class="line">	<span class="keyword">while</span> (scanf(<span class="string">"%d"</span>, &amp;N) == <span class="number">1</span>) {</div><div class="line">		A.init(<span class="number">65536</span>), B.init(<span class="number">65536</span>);</div><div class="line">		<span class="keyword">int</span> max_y = <span class="number">0</span>;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) {</div><div class="line">			pt.read(), max_y = <span class="keyword">max</span>(max_y, pt.y);</div><div class="line">			B.addEvent(<span class="number">0</span>, <span class="number">2</span><span class="variable">*i</span>, pt);</div><div class="line">			A.addEvent(<span class="number">1</span>, <span class="number">2</span><span class="variable">*i</span>, pt);</div><div class="line">			pt.read(), max_y = <span class="keyword">max</span>(max_y, pt.y);</div><div class="line">			A.addEvent(<span class="number">0</span>, <span class="number">2</span><span class="variable">*i</span>+<span class="number">1</span>, pt);</div><div class="line">			B.addEvent(<span class="number">1</span>, <span class="number">2</span><span class="variable">*i</span>+<span class="number">1</span>, pt);</div><div class="line">		}</div><div class="line">		A.N = B.N = max_y;	<span class="comment">// y in [1, max_y]</span></div><div class="line">		A.run(), B.run();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) {</div><div class="line">			<span class="keyword">if</span> (i)	printf(<span class="string">"%d\n"</span>, B.ret[<span class="number">2</span><span class="variable">*i</span>]);</div><div class="line">			printf(<span class="string">"%d\n"</span>, A.ret[<span class="number">2</span><span class="variable">*i</span>+<span class="number">1</span>]);</div><div class="line">		}</div><div class="line">	}</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-b443" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/07/15/zj-b443/" class="article-date">
  <time datetime="2015-07-15T07:35:28.000Z" itemprop="datePublished">Jul 15 2015</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>►<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/07/15/zj-b443/">b443. 我愛 Fibonacci</a>
    </h1>
  

      </header>
        
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/07/15/zj-b443/" data-id="uoy9p3imc7anbkcl" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/07/15/zj-b443/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/miller-rabin/">miller-rabin</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pollard-rho/">pollard-rho</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/二次剩餘/">二次剩餘</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/分治/">分治</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/判斷質數/">判斷質數</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/數論基礎/">數論基礎</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/模乘法/">模乘法</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/生成因數/">生成因數</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/矩陣/">矩陣</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/規律/">規律</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem">Problem</h2>
<span>$$F_n=\begin{cases}
n, & n=0,1 \\
F_{n-1}+F_{n-2}, & n \geq 2
\end{cases}$$</span>

<p>求出 <span>$F_{2^n} \mod m$</span> 的結果。</p>
<h2 id="Sample_Input">Sample Input</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">3</div><div class="line">1 1000000007</div><div class="line">2 1000000007</div><div class="line">3 1000000007</div></pre></td></tr></table></figure>

<h2 id="Sample_Output">Sample Output</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">1</div><div class="line">3</div><div class="line">21</div></pre></td></tr></table></figure>

<h2 id="Solution">Solution</h2>
<p>一般的矩陣計算，利用 $M^n$ 求出 <span>$F_n$</span>，其中</p>
<span>$$M = \begin{bmatrix}
1 & 1\\ 
1 & 0 
\end{bmatrix}$$</span>

<p>如果是求 <span>$F_n$</span> 時間複雜度 $O(\log n)$，而這一題求的是 <span>$F_{2^n}$</span>，時間複雜度 $O(n)$。</p>
<p>為了加速運算，目標是要找到 $\mod p$ 下的循環長度 $L$，最後求出 <span>$F_{2^n \mod L}$</span>，根據待會的證明，保證 $L \le p$，那複雜度就可以回到 $O(\log L)$ 解決。但為了要找到 $L$ 又是一段很長的故事，總時間複雜度為 $O(\sqrt{p})$，不用保證 $p$ 是質數。</p>
<h3 id="參考資料">參考資料</h3>
<ul>
<li><a href="http://wenku.baidu.com/view/20ce902e2af90242a895e5c1" target="_blank" rel="external">《HDOJ3977 Evil teacher 斐波拉契数列模 p 循环节》</a></li>
</ul>
<h3 id="故事">故事</h3>
<p>數列 <span>$F_0 = 1, F_1 = 1, F_2 = 2, \cdots$</span>，循環是連續兩項出現重複，而費氏數列會完全循環，也就是出現連續兩項 <span>$F_i = 0, F_{i-1} = 1$</span>。下方是一個 $\mod 4$ 的情況。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">1</span> <span class="number">0</span> | <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">1</span> <span class="number">0</span> | <span class="keyword">...</span></div></pre></td></tr></table></figure>

<p>要找到恰好連續兩項 <span>$F_i = 0, F_{i-1} = 1$</span> 是困難的，考慮去找到 <span>$F_i = 0$</span> 即可，接著再去想辦法讓 <span>$F_{i-1} = 1$</span>。</p>
<p>假設最小的 $k$ 滿足 <span>$F_k = 0 \mod p$</span>，而 <span>$F_{k-1} = a \mod p$</span>，那麼之後的序列 <span>$F_{i} = a^j F_{i+j \times k} \mod p$</span>。從矩陣乘法的概念中可以理解，是一個常數為 $a$ 的初始項，第二輪循環常數就會變成 $a^2$，類推。</p>
<p>接下來</p>
<ul>
<li>考慮一個嚴重的問題「<strong> 何種模 $p$ 情況一定循環，即從 <span>$F_0$</span> 再次循環。 </strong>」答案是 <strong> 質數 $p$ </strong>。<br>原因是 <span>$F_{i} = a^j F_{i+j \times k} \mod p$</span>，由於 $a$ 與 $p$ 互質，$a^j \mod p \neq 0$ 恆成立，同時還是一個 $ord_{p}(a) = p-1$，這部分從歐拉定理中可以了解，那麼只有可能在 <span>$F_{i} = 0$</span> 的情況成立，就是 $k$ 的倍數之外，不發生 <span>$F_i = 0$</span> 的出現。</li>
<li>接續上一個問題「模 $p$ 不是質數怎麼處理？」<br>進行質因數分解，對於每一個質因子找到模循環長度，模 $p$ 循環長度就是所有質因子循環長度的最小公倍數 lcm。</li>
</ul>
<p>現在問題落在 $k$ 怎麼找到，若能找到 $k$，其循環長度落在 $k$ 的倍數，或者有更好的獲取方式。</p>
<ul>
<li>若模質數 $p$ 且滿足 $p &gt; 5$，5 是 $p$ 的二次剩餘 (quadratic residue)，意即滿足 $\exists \; x^2 \equiv 5 \mod p$，循環長度為 $p-1$ 的因數。反之，循環長度是 $2(p+1)$ 的因數。</li>
</ul>
<p>關於二次剩餘的判斷，在模質數 $p$ 下，對於 $gcd(x, p) = 1$，藉由歐拉定理得到 $x^{p-1} \equiv 1 \mod p$，以下不保證是正確的說法，提供理解的一個方案。</p>
<ul>
<li>若 $d$ 是 $p$ 的二次剩餘，則滿足 $d^{(p-1)/2} \equiv 1 \mod p$，因為 <span>$x^{2 \times (p-1)/2} \equiv 1 \mod p \Rightarrow  x^{p-1} \equiv 1 \mod p$</span>。</li>
<li>若非二次剩餘，則滿足 $d^{(p-1)/2} \equiv -1 \mod p$，因為 $\left [ d^{(p-1)/2} \right ]^2 \equiv 1 \mod p \Rightarrow d^{p-1} \equiv 1 \mod p$</li>
<li>數學上用 Legendre symbol 來表示這個判斷 <a href="https://en.wikipedia.org/wiki/Legendre_symbol" target="_blank" rel="external">wiki</a>。</li>
</ul>
<p>回過頭來，看一下費氏數列的公式解</p>
<span>$$F_n = \frac{1}{\sqrt{5}} \left [ \left ( \frac{1+\sqrt{5}}{2} \right )^n - \left (\frac{1-\sqrt{5}}{2} \right )^n \right ]$$</span>

<p>藉由展開公式，儘管它是實數、根號，展開之後一定只會剩下整數冪次的總和。令 $a = \sqrt{5}$，觀察二次剩餘與否和滿足 <span>$F_n = 0$</span> 的關係。</p>
<p>在模質數 $p$ 下，滿足二次剩餘 <span>$F_n \equiv 0 \mod p$</span>，當 $n = p-1$ 的時候成立，可以藉由噁心的展開式得到。同理在非二次剩餘情況，$n = 2(p+1)$，找到一個最大的倍數情況，答案一定落在其因數下。詳細推導請看參考資料，太噁心就不提。</p>
<p>參考資料中有特別提到，有一個地方還 <strong> 沒有確認 </strong>，對於模數 $p^k$ 的循環長度 $g(p) \times p^{k-1}$ 如何證明。但我想根據中國餘式定理，能了解循環長度倍數的模關係吧。接著由於大整數分解期望是 $O(\sqrt{n})$，中間也要找到所有因數來得到循環長度的驗證，還要搭配快速矩陣乘法，最後也是 $O(\sqrt{n})$。</p>
<p>這一題是更進階的費氏數列計算，從建表、矩陣乘法，最後來到循環搜尋，這些證明不久之後就會忘記了，二次剩餘判斷的想法還會留著，其他就忘得一乾二淨吧。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;bits/stdc++.h&gt; </span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="preprocessor">#<span class="keyword">define</span> MILLER_BABIN 4</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> UINT64;</div><div class="line">UINT64 mul(UINT64 a, UINT64 b, UINT64 mod) { </div><div class="line">	UINT64 ret = <span class="number">0</span>; </div><div class="line">	<span class="keyword">for</span> (a = a &gt;= mod ? a%mod : a, b = b &gt;= mod ? b%mod : b; b != <span class="number">0</span>; b&gt;&gt;=<span class="number">1</span>, a &lt;&lt;= <span class="number">1</span>, a = a &gt;= mod ? a - mod : a) { </div><div class="line">		<span class="keyword">if</span> (b&amp;<span class="number">1</span>) {</div><div class="line">			ret += a;</div><div class="line">			<span class="keyword">if</span> (ret &gt;= mod) </div><div class="line">				ret -= mod;</div><div class="line">		} </div><div class="line">	} </div><div class="line">	<span class="keyword">return</span> ret; </div><div class="line">}</div><div class="line"><span class="keyword">struct</span> Matrix {</div><div class="line">    UINT64 v[<span class="number">2</span>][<span class="number">2</span>];</div><div class="line">    <span class="keyword">int</span> row, col; <span class="comment">// row x col</span></div><div class="line">    Matrix(<span class="keyword">int</span> n, <span class="keyword">int</span> m, <span class="keyword">int</span> a = <span class="number">0</span>) {</div><div class="line">        <span class="built_in">memset</span>(v, <span class="number">0</span>, <span class="keyword">sizeof</span>(v));</div><div class="line">        row = n, col = m;</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; row &amp;&amp; i &lt; col; i++)</div><div class="line">            v[i][i] = a;</div><div class="line">    }    </div><div class="line">	Matrix multiply(<span class="keyword">const</span> Matrix&amp; x, <span class="keyword">const</span> <span class="keyword">long</span> <span class="keyword">long</span> mod) <span class="keyword">const</span> {</div><div class="line">        Matrix ret(row, x.col);</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; row; i++) {</div><div class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; col; k++) {</div><div class="line">                <span class="keyword">if</span> (!v[i][k])</div><div class="line">                	<span class="keyword">continue</span>;</div><div class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; x.col; j++) {</div><div class="line">                    ret.v[i][j] += mul(v[i][k], x.v[k][j], mod);</div><div class="line">                    <span class="keyword">if</span> (ret.v[i][j] &gt;= mod)</div><div class="line">                    	ret.v[i][j] -= mod;</div><div class="line">                }</div><div class="line">            }</div><div class="line">        }</div><div class="line">        <span class="keyword">return</span> ret;</div><div class="line">    }</div><div class="line">    Matrix <span class="built_in">pow</span>(<span class="keyword">const</span> <span class="keyword">long</span> <span class="keyword">long</span>&amp; n, <span class="keyword">const</span> <span class="keyword">long</span> <span class="keyword">long</span> mod) <span class="keyword">const</span> {</div><div class="line">        Matrix ret(row, col, <span class="number">1</span>), x = *<span class="keyword">this</span>;</div><div class="line">        <span class="keyword">long</span> <span class="keyword">long</span> y = n;</div><div class="line">        <span class="keyword">while</span>(y) {</div><div class="line">            <span class="keyword">if</span>(y&amp;<span class="number">1</span>)	ret = ret.multiply(x, mod);</div><div class="line">            y = y&gt;&gt;<span class="number">1</span>, x = x.multiply(x, mod);</div><div class="line">        }</div><div class="line">        <span class="keyword">return</span> ret;</div><div class="line">    }</div><div class="line">} FibA(<span class="number">2</span>, <span class="number">2</span>, <span class="number">0</span>);</div><div class="line"></div><div class="line"><span class="preprocessor">#<span class="keyword">define</span> MAXL (50000&gt;&gt;5)+1</span></div><div class="line"><span class="preprocessor">#<span class="keyword">define</span> GET(x) (mark[x&gt;&gt;5]&gt;&gt;(x&amp;31)&amp;1)</span></div><div class="line"><span class="preprocessor">#<span class="keyword">define</span> SET(x) (mark[x&gt;&gt;5] |= 1&lt;&lt;(x&amp;31))</span></div><div class="line"><span class="keyword">int</span> mark[MAXL], P[<span class="number">50000</span>], Pt = <span class="number">0</span>;</div><div class="line"><span class="keyword">void</span> sieve() {</div><div class="line">    <span class="keyword">register</span> <span class="keyword">int</span> i, j, k;</div><div class="line">    SET(<span class="number">1</span>);</div><div class="line">    <span class="keyword">int</span> n = <span class="number">46340</span>;</div><div class="line">    <span class="keyword">for</span> (i = <span class="number">2</span>; i &lt;= n; i++) {</div><div class="line">        <span class="keyword">if</span> (!GET(i)) {</div><div class="line">            <span class="keyword">for</span> (k = n/i, j = i*k; k &gt;= i; k--, j -= i)</div><div class="line">                SET(j);</div><div class="line">            P[Pt++] = i;</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line">UINT64 mpow(UINT64 x, UINT64 y, UINT64 mod) { <span class="comment">// mod &lt; 2^32 </span></div><div class="line">	UINT64 ret = <span class="number">1</span>;</div><div class="line">	<span class="keyword">while</span> (y) {</div><div class="line">		<span class="keyword">if</span> (y&amp;<span class="number">1</span>) </div><div class="line">			ret = (ret * x)%mod;</div><div class="line">		y &gt;&gt;= <span class="number">1</span>, x = (x * x)%mod;</div><div class="line">	}</div><div class="line">	<span class="keyword">return</span> ret % mod;</div><div class="line">}</div><div class="line">UINT64 mpow2(UINT64 x, UINT64 y, UINT64 mod) {</div><div class="line">	UINT64 ret = <span class="number">1</span>;</div><div class="line">	<span class="keyword">while</span> (y) {</div><div class="line">		<span class="keyword">if</span> (y&amp;<span class="number">1</span>)</div><div class="line">			ret = mul(ret, x, mod);</div><div class="line">		y &gt;&gt;= <span class="number">1</span>, x = mul(x, x, mod);</div><div class="line">	}</div><div class="line">	<span class="keyword">return</span> ret;</div><div class="line">} </div><div class="line"><span class="keyword">void</span> exgcd(<span class="keyword">long</span> <span class="keyword">long</span> x, <span class="keyword">long</span> <span class="keyword">long</span> y, <span class="keyword">long</span> <span class="keyword">long</span> &amp;g, <span class="keyword">long</span> <span class="keyword">long</span> &amp;a, <span class="keyword">long</span> <span class="keyword">long</span> &amp;b) {</div><div class="line">	<span class="keyword">if</span> (y == <span class="number">0</span>)</div><div class="line">		g = x, a = <span class="number">1</span>, b = <span class="number">0</span>;</div><div class="line">	<span class="keyword">else</span></div><div class="line">		exgcd(y, x%y, g, b, a), b -= (x/y) * a;</div><div class="line">}</div><div class="line"><span class="keyword">long</span> <span class="keyword">long</span> llgcd(<span class="keyword">long</span> <span class="keyword">long</span> x, <span class="keyword">long</span> <span class="keyword">long</span> y) {</div><div class="line">    <span class="keyword">if</span> (x &lt; <span class="number">0</span>)    x = -x;</div><div class="line">    <span class="keyword">if</span> (y &lt; <span class="number">0</span>)    y = -y;</div><div class="line">	<span class="keyword">if</span> (!x || !y)    <span class="keyword">return</span> x + y;</div><div class="line">	<span class="keyword">long</span> <span class="keyword">long</span> t;</div><div class="line">	<span class="keyword">while</span> (x%y)</div><div class="line">		t = x, x = y, y = t%y;</div><div class="line">	<span class="keyword">return</span> y;</div><div class="line">}</div><div class="line"><span class="keyword">long</span> <span class="keyword">long</span> inverse(<span class="keyword">long</span> <span class="keyword">long</span> x, <span class="keyword">long</span> <span class="keyword">long</span> p) {</div><div class="line">	<span class="keyword">long</span> <span class="keyword">long</span> g, b, r;</div><div class="line">	exgcd(x, p, g, r, b);</div><div class="line">	<span class="keyword">if</span> (g &lt; <span class="number">0</span>)	r = -r;</div><div class="line">	<span class="keyword">return</span> (r%p + p)%p;</div><div class="line">}</div><div class="line"><span class="keyword">int</span> isPrime(<span class="keyword">long</span> <span class="keyword">long</span> p) { <span class="comment">// implements by miller-babin</span></div><div class="line">	<span class="keyword">if</span> (p &lt; <span class="number">2</span> || !(p&amp;<span class="number">1</span>))	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">	<span class="keyword">if</span> (p == <span class="number">2</span>)				<span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">	<span class="keyword">long</span> <span class="keyword">long</span> q = p-<span class="number">1</span>, a, t;</div><div class="line">	<span class="keyword">int</span> k = <span class="number">0</span>, b = <span class="number">0</span>;</div><div class="line">	<span class="keyword">while</span> (!(q&amp;<span class="number">1</span>))	q &gt;&gt;= <span class="number">1</span>, k++;</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> it = <span class="number">0</span>; it &lt; MILLER_BABIN; it++) {</div><div class="line">		a = rand()%(p-<span class="number">4</span>) + <span class="number">2</span>;</div><div class="line">		t = mpow2(a, q, p);</div><div class="line">		b = (t == <span class="number">1</span>) || (t == p-<span class="number">1</span>);</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; k &amp;&amp; !b; i++) {</div><div class="line">			t = mul(t, t, p);</div><div class="line">			<span class="keyword">if</span> (t == p-<span class="number">1</span>)</div><div class="line">				b = <span class="number">1</span>;</div><div class="line">		}</div><div class="line">		<span class="keyword">if</span> (b == <span class="number">0</span>)</div><div class="line">			<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">	}</div><div class="line">	<span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">}</div><div class="line"><span class="keyword">long</span> <span class="keyword">long</span> pollard_rho(<span class="keyword">long</span> <span class="keyword">long</span> n, <span class="keyword">long</span> <span class="keyword">long</span> c) {</div><div class="line">	<span class="keyword">long</span> <span class="keyword">long</span> x = <span class="number">2</span>, y = <span class="number">2</span>, i = <span class="number">1</span>, k = <span class="number">2</span>, d;</div><div class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) {</div><div class="line">        x = (mul(x, x, n) + c);</div><div class="line">        <span class="keyword">if</span> (x &gt;= n)	x -= n;</div><div class="line">        d = llgcd(x - y, n);</div><div class="line">        <span class="keyword">if</span> (d &gt; <span class="number">1</span>) <span class="keyword">return</span> d;</div><div class="line">        <span class="keyword">if</span> (++i == k) y = x, k &lt;&lt;= <span class="number">1</span>;</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> n;</div><div class="line">}</div><div class="line"><span class="keyword">void</span> factorize(<span class="keyword">int</span> n, <span class="stl_container"><span class="built_in">vector</span>&lt;<span class="keyword">long</span> <span class="keyword">long</span>&gt;</span> &amp;f) {</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; Pt &amp;&amp; P[i]*P[i] &lt;= n; i++) {</div><div class="line">    	<span class="keyword">if</span> (n%P[i] == <span class="number">0</span>) {</div><div class="line">    		<span class="keyword">while</span> (n%P[i] == <span class="number">0</span>)</div><div class="line">    			f.push_back(P[i]), n /= P[i];</div><div class="line">    	}</div><div class="line">    }</div><div class="line">    <span class="keyword">if</span> (n != <span class="number">1</span>)	f.push_back(n);</div><div class="line">}</div><div class="line"><span class="keyword">void</span> llfactorize(<span class="keyword">long</span> <span class="keyword">long</span> n, <span class="stl_container"><span class="built_in">vector</span>&lt;<span class="keyword">long</span> <span class="keyword">long</span>&gt;</span> &amp;f) {</div><div class="line">	<span class="keyword">if</span> (n == <span class="number">1</span>)	</div><div class="line">		<span class="keyword">return</span> ;	</div><div class="line">	<span class="keyword">if</span> (n &lt; <span class="number">1e+9</span>) {</div><div class="line">		factorize(n, f);</div><div class="line">		<span class="keyword">return</span> ;</div><div class="line">	}</div><div class="line">	<span class="keyword">if</span> (isPrime(n)) {</div><div class="line">		f.push_back(n);</div><div class="line">		<span class="keyword">return</span> ;</div><div class="line">	}</div><div class="line">	<span class="keyword">long</span> <span class="keyword">long</span> d = n;</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; d == n; i++)</div><div class="line">		d = pollard_rho(n, i);</div><div class="line">	llfactorize(d, f);</div><div class="line">	llfactorize(n/d, f);</div><div class="line">}</div><div class="line"><span class="comment">// above largest factor</span></div><div class="line"><span class="comment">// ---------------------- //</span></div><div class="line"><span class="keyword">int</span> legendre_symbol(UINT64 d, UINT64 p) {</div><div class="line">	<span class="keyword">if</span> (d%p == <span class="number">0</span>)	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">	<span class="keyword">return</span> mpow2(d, (p-<span class="number">1</span>)&gt;&gt;<span class="number">1</span>, p) == <span class="number">1</span> ? <span class="number">1</span> : -<span class="number">1</span>;</div><div class="line">}</div><div class="line"><span class="keyword">void</span> factor_gen(<span class="keyword">int</span> idx, <span class="keyword">long</span> <span class="keyword">long</span> x, <span class="stl_container"><span class="built_in">vector</span>&lt; pair&lt;<span class="keyword">long</span> <span class="keyword">long</span>, <span class="keyword">int</span>&gt;</span> &gt; &amp;f, <span class="stl_container"><span class="built_in">vector</span>&lt;<span class="keyword">long</span> <span class="keyword">long</span>&gt;</span> &amp;ret) {</div><div class="line">	<span class="keyword">if</span> (idx == f.size()) {</div><div class="line">		ret.push_back(x);</div><div class="line">		<span class="keyword">return</span> ;</div><div class="line">	}</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">long</span> <span class="keyword">long</span> i = <span class="number">0</span>, a = <span class="number">1</span>; i &lt;= f[idx].second; i++, a *= f[idx].first)</div><div class="line">		factor_gen(idx+<span class="number">1</span>, x*a, f, ret);</div><div class="line">}</div><div class="line"><span class="keyword">void</span> factor_gen(<span class="keyword">long</span> <span class="keyword">long</span> n, <span class="stl_container"><span class="built_in">vector</span>&lt;<span class="keyword">long</span> <span class="keyword">long</span>&gt;</span> &amp;ret) {</div><div class="line">	<span class="stl_container"><span class="built_in">vector</span>&lt;<span class="keyword">long</span> <span class="keyword">long</span>&gt;</span> f;</div><div class="line">	<span class="stl_container"><span class="built_in">vector</span>&lt; pair&lt;<span class="keyword">long</span> <span class="keyword">long</span>, <span class="keyword">int</span>&gt;</span> &gt; f2;</div><div class="line">	llfactorize(n, f);</div><div class="line">	sort(f.begin(), f.end());</div><div class="line">	<span class="keyword">int</span> cnt = <span class="number">1</span>;</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= f.size(); i++) {</div><div class="line">		<span class="keyword">if</span> (i == f.size() || f[i] != f[i-<span class="number">1</span>])</div><div class="line">			f2.push_back(make_pair(f[i-<span class="number">1</span>], cnt)), cnt = <span class="number">1</span>;</div><div class="line">		<span class="keyword">else</span></div><div class="line">			cnt ++;</div><div class="line">	}</div><div class="line">	factor_gen(<span class="number">0</span>, <span class="number">1</span>, f2, ret);</div><div class="line">	sort(ret.begin(), ret.end());</div><div class="line">}</div><div class="line">UINT64 cycleInFib(UINT64 p) {</div><div class="line">	<span class="keyword">if</span> (p == <span class="number">2</span>)	<span class="keyword">return</span> <span class="number">3</span>;</div><div class="line">	<span class="keyword">if</span> (p == <span class="number">3</span>)	<span class="keyword">return</span> <span class="number">8</span>;</div><div class="line">	<span class="keyword">if</span> (p == <span class="number">5</span>)	<span class="keyword">return</span> <span class="number">20</span>;</div><div class="line">	<span class="stl_container"><span class="built_in">vector</span>&lt;<span class="keyword">long</span> <span class="keyword">long</span>&gt;</span> f;</div><div class="line">	<span class="keyword">if</span> (legendre_symbol(<span class="number">5</span>, p) == <span class="number">1</span>)</div><div class="line">		factor_gen(p-<span class="number">1</span>, f);</div><div class="line">	<span class="keyword">else</span></div><div class="line">		factor_gen(<span class="number">2</span>*(p+<span class="number">1</span>), f);</div><div class="line">	<span class="keyword">long</span> <span class="keyword">long</span> f1, f2;</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; f.size(); i++) {</div><div class="line">		Matrix t = FibA.<span class="built_in">pow</span>(f[i]-<span class="number">1</span>, p);</div><div class="line">		f1 = (t.v[<span class="number">0</span>][<span class="number">0</span>] + t.v[<span class="number">0</span>][<span class="number">1</span>])%p;</div><div class="line">		f2 = (t.v[<span class="number">1</span>][<span class="number">0</span>] + t.v[<span class="number">1</span>][<span class="number">1</span>])%p;</div><div class="line">		<span class="keyword">if</span> (f1 == <span class="number">1</span> &amp;&amp; f2 == <span class="number">0</span>)</div><div class="line">			<span class="keyword">return</span> f[i];</div><div class="line">	}</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div><div class="line">UINT64 cycleInFib(UINT64 p, <span class="keyword">int</span> k) {</div><div class="line">	UINT64 s = cycleInFib(p);</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; k; i++)</div><div class="line">		s = s * p;</div><div class="line">	<span class="keyword">return</span> s;</div><div class="line">}</div><div class="line"><span class="keyword">int</span> main() {</div><div class="line">	sieve();</div><div class="line">	FibA.v[<span class="number">0</span>][<span class="number">0</span>] = <span class="number">1</span>, FibA.v[<span class="number">0</span>][<span class="number">1</span>] = <span class="number">1</span>;</div><div class="line">	FibA.v[<span class="number">1</span>][<span class="number">0</span>] = <span class="number">1</span>, FibA.v[<span class="number">1</span>][<span class="number">1</span>] = <span class="number">0</span>;</div><div class="line">	</div><div class="line">	<span class="keyword">int</span> testcase;</div><div class="line">	<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;testcase);</div><div class="line">	<span class="keyword">while</span> (testcase--) {</div><div class="line">		<span class="keyword">long</span> <span class="keyword">long</span> n, m;</div><div class="line">		<span class="built_in">scanf</span>(<span class="string">"%lld %lld"</span>, &amp;n, &amp;m);</div><div class="line">		</div><div class="line">		<span class="stl_container"><span class="built_in">vector</span>&lt;<span class="keyword">long</span> <span class="keyword">long</span>&gt;</span> f;</div><div class="line">		<span class="stl_container"><span class="built_in">map</span>&lt;<span class="keyword">long</span> <span class="keyword">long</span>, <span class="keyword">int</span>&gt;</span> r;</div><div class="line">			</div><div class="line">		llfactorize(m, f);</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">auto</span> &amp;x : f)</div><div class="line">			r[x]++;</div><div class="line">			</div><div class="line">		UINT64 cycle = <span class="number">1</span>; </div><div class="line">		<span class="keyword">for</span> (<span class="keyword">auto</span> &amp;x : r) {</div><div class="line">			UINT64 t = cycleInFib(x.first, x.second);</div><div class="line">			cycle = cycle / llgcd(t, cycle) * t;</div><div class="line">		}</div><div class="line">		</div><div class="line">		n = mpow2(<span class="number">2</span>, n, cycle);</div><div class="line">		Matrix t = FibA.<span class="built_in">pow</span>(n, m);</div><div class="line">		<span class="keyword">long</span> <span class="keyword">long</span> fn = t.v[<span class="number">1</span>][<span class="number">0</span>];</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"%lld\n"</span>, fn);</div><div class="line">	}</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-b444" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/07/13/zj-b444/" class="article-date">
  <time datetime="2015-07-12T22:40:23.000Z" itemprop="datePublished">Jul 13 2015</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>►<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/07/13/zj-b444/">b444. 期望試驗 快速冪次</a>
    </h1>
  

      </header>
        
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/07/13/zj-b444/" data-id="w4k0kjq42w9868aq" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/07/13/zj-b444/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/密碼基礎/">密碼基礎</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem">Problem</h2>
<h3 id="背景">背景</h3>
<p>曾經某 M 被期望值坑，就只是在計算 $x^y \mod z$ 時偷偷替換成 $x^{y-1} \times x \mod z$，結果得到 Time Limit Exceeded。</p>
<p>根據分析 $y = 16$ 時，用二進制表示為 <span>$(10000)_{2}$</span>，若變成 $y = 15$，就會變成 <span>$(01111)_{2}$</span>，通常快速求冪的乘法次數與二進制的 1 個數成正比，所以速度就慢非常多。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">typedef unsigned <span class="keyword">long</span> <span class="keyword">long</span> UINT64;</div><div class="line">UINT64 mul(UINT64 a, UINT64 b, UINT64 <span class="keyword">mod</span>) { </div><div class="line">	UINT64 ret = <span class="number">0</span>; </div><div class="line">	<span class="keyword">for</span> (a = a &gt;= <span class="keyword">mod</span> ? a%<span class="keyword">mod</span> : a, b = b &gt;= <span class="keyword">mod</span> ? b%<span class="keyword">mod</span> : b; b != <span class="number">0</span>; b&gt;&gt;=<span class="number">1</span>, a &lt;&lt;= <span class="number">1</span>, a = a &gt;= <span class="keyword">mod</span> ? a - <span class="keyword">mod</span> : a) { </div><div class="line">		<span class="keyword">if</span> (b&<span class="number">1</span>) {</div><div class="line">			ret += a;</div><div class="line">			<span class="keyword">if</span> (ret &gt;= <span class="keyword">mod</span>) </div><div class="line">				ret -= <span class="keyword">mod</span>;</div><div class="line">		} </div><div class="line">	} </div><div class="line">	<span class="keyword">return</span> ret; </div><div class="line">}</div><div class="line">UINT64 mpow(UINT64 x, UINT64 y, UINT64 <span class="keyword">mod</span>) {</div><div class="line">	UINT64 ret = <span class="number">1</span>;</div><div class="line">	<span class="keyword">while</span> (y) {</div><div class="line">		<span class="keyword">if</span> (y&<span class="number">1</span>)</div><div class="line">			ret = mul(ret, x, <span class="keyword">mod</span>);</div><div class="line">		y &gt;&gt;= <span class="number">1</span>, x = mul(x, x, <span class="keyword">mod</span>);</div><div class="line">	}</div><div class="line">	<span class="keyword">return</span> ret;</div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="問題描述">問題描述</h3>
<p>讓我們來一場 $x^y \mod z$ 的期望值試驗吧，基礎目標是減少乘法次數。</p>
<p>其中 $1 \le x, z \le 10^{18}$, $0 \le y \le 2^{2^{20}}$，在這場試驗中展現你的優化吧。</p>
<h2 id="Sample_Input">Sample Input</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">5 01 7</div><div class="line">5 10 7</div><div class="line">5 0101 7</div><div class="line">3 0110 7</div></pre></td></tr></table></figure>

<h2 id="Sample_Output">Sample Output</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">5</div><div class="line">4</div><div class="line">3</div><div class="line">1</div></pre></td></tr></table></figure>

<h2 id="Solution">Solution</h2>
<p>詳細可以參考《資訊安全 - 近代加密 快速冪次計算》那一篇。</p>
<table>
<thead>
<tr>
<th>Algorithm</th>
<th>Table Size</th>
<th>#squaring</th>
<th>Average #Multiplication</th>
</tr>
</thead>
<tbody>
<tr>
<td>Right-To-Left</td>
<td>1: $x^{2^i}$</td>
<td>$n$</td>
<td>$n/2$</td>
</tr>
<tr>
<td>Left-To-Right</td>
<td>1: $x$</td>
<td>$n$</td>
<td>$n/2$</td>
</tr>
<tr>
<td>Left-To-Right(2-bits)</td>
<td>3: $x$, $x^2$, $x^3$</td>
<td>$n$</td>
<td>$3n/8$</td>
</tr>
<tr>
<td>Left-To-Right(sliding)</td>
<td>2: $x$, $x^3$</td>
<td>$n$</td>
<td>$n/3$</td>
</tr>
</tbody>
</table>
<p>減少乘法次數，但以上期望乘法次數是跟 1 的個數有關，雖然最好是從 $n/2$ 降到 $n/3$，並不表示速度會真的快上 $1.5$ 倍左右，畢竟還有所謂的基礎乘法次數需求，根據實驗下來大約能快個 10% 到 20% 之間，加上 <code>-Ofast</code> 編譯此時的差異又會再少一點，看起來實作方法影響很嚴重。</p>
<p>例如在不加編譯優化參數下</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> <span class="operator">a</span>[i] == <span class="number">0</span> && <span class="operator">a</span>[i+<span class="number">1</span>] == <span class="number">0</span></div><div class="line"><span class="keyword">else</span> <span class="keyword">if</span> <span class="operator">a</span>[i] == <span class="number">0</span> && <span class="operator">a</span>[i+<span class="number">1</span>] == <span class="number">1</span></div><div class="line"><span class="keyword">else</span> <span class="keyword">if</span> <span class="operator">a</span>[i] == <span class="number">1</span> && <span class="operator">a</span>[i+<span class="number">1</span>] == <span class="number">0</span></div><div class="line"><span class="keyword">else</span></div></pre></td></tr></table></figure>

<p>上述做法會比下述來得快上許多</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> <span class="operator">a</span>[i] == <span class="number">0</span></div><div class="line">	<span class="keyword">if</span> <span class="operator">a</span>[i+<span class="number">1</span>] == <span class="number">0</span></div><div class="line">	<span class="keyword">else</span></div><div class="line"><span class="keyword">else</span></div><div class="line">	<span class="keyword">if</span> <span class="operator">a</span>[i+<span class="number">1</span>] == <span class="number">0</span></div><div class="line">	<span class="keyword">else</span></div></pre></td></tr></table></figure>

<p>最後，產出一個 cheat 版本，使用 L-to-R-2bits 的概念下去擴充，使用 loop unrolling 進行加速，由於會發生不被整除的問題，小測資就靠 L-to-R-sliding 的方案去解決。</p>
<p>在 zerojudge 主機上平台上，隨機測資下的運作情況如下：</p>
<table>
<thead>
<tr>
<th>Algorithm</th>
<th>Time</th>
</tr>
</thead>
<tbody>
<tr>
<td>Right-To-Left</td>
<td>5.4s</td>
</tr>
<tr>
<td>Left-To-Right(2-bits)</td>
<td>4.9s</td>
</tr>
<tr>
<td>Left-To-Right(sliding)</td>
<td>4.8s</td>
</tr>
<tr>
<td>Left-To-Right-sliding-cheat</td>
<td>4.2s</td>
</tr>
</tbody>
</table>
<h3 id="R-to-L">R-to-L</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;bits/stdc++.h&gt; </span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> UINT64;</div><div class="line">UINT64 mul(UINT64 a, UINT64 b, UINT64 mod) { </div><div class="line">	UINT64 ret = <span class="number">0</span>; </div><div class="line">	<span class="keyword">for</span> (a = a &gt;= mod ? a%mod : a, b = b &gt;= mod ? b%mod : b; b != <span class="number">0</span>; b&gt;&gt;=<span class="number">1</span>, a &lt;&lt;= <span class="number">1</span>, a = a &gt;= mod ? a - mod : a) { </div><div class="line">		<span class="keyword">if</span> (b&amp;<span class="number">1</span>) {</div><div class="line">			ret += a;</div><div class="line">			<span class="keyword">if</span> (ret &gt;= mod) </div><div class="line">				ret -= mod;</div><div class="line">		} </div><div class="line">	} </div><div class="line">	<span class="keyword">return</span> ret; </div><div class="line">}</div><div class="line">UINT64 mpowR2L(UINT64 x, <span class="keyword">char</span> y[], UINT64 z) {</div><div class="line">	<span class="keyword">int</span> n;</div><div class="line">	<span class="keyword">for</span> (n = <span class="number">1</span>; y[n]; n &lt;&lt;= <span class="number">1</span>);</div><div class="line">	UINT64 ret = <span class="number">1</span>;</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = n-<span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) {</div><div class="line">		<span class="keyword">if</span> (y[i] == <span class="string">'1'</span>)</div><div class="line">			ret = mul(ret, x, z);</div><div class="line">		x = mul(x, x, z);</div><div class="line">	}</div><div class="line">	<span class="keyword">return</span> ret;</div><div class="line">}</div><div class="line"><span class="keyword">char</span> y[(<span class="number">1</span>&lt;&lt;<span class="number">20</span>) + <span class="number">5</span>];</div><div class="line"><span class="keyword">int</span> main() {</div><div class="line">	<span class="keyword">long</span> <span class="keyword">long</span> x, z;</div><div class="line">	<span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%lld %s %lld"</span>, &amp;x, y, &amp;z) == <span class="number">3</span>) {</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"%llu\n"</span>, mpowR2L(x, y, z));</div><div class="line">	}</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="L-to-R-2bits">L-to-R-2bits</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;bits/stdc++.h&gt; </span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> UINT64;</div><div class="line">UINT64 mul(UINT64 a, UINT64 b, UINT64 mod) { </div><div class="line">	UINT64 ret = <span class="number">0</span>; </div><div class="line">	<span class="keyword">for</span> (a = a &gt;= mod ? a%mod : a, b = b &gt;= mod ? b%mod : b; b != <span class="number">0</span>; b&gt;&gt;=<span class="number">1</span>, a &lt;&lt;= <span class="number">1</span>, a = a &gt;= mod ? a - mod : a) { </div><div class="line">		<span class="keyword">if</span> (b&amp;<span class="number">1</span>) {</div><div class="line">			ret += a;</div><div class="line">			<span class="keyword">if</span> (ret &gt;= mod) </div><div class="line">				ret -= mod;</div><div class="line">		} </div><div class="line">	} </div><div class="line">	<span class="keyword">return</span> ret; </div><div class="line">}</div><div class="line">UINT64 mpowL2R2(UINT64 x, <span class="keyword">char</span> y[], UINT64 z) {</div><div class="line">	UINT64 x2 = mul(x, x, z);</div><div class="line">	UINT64 x3 = mul(x2, x, z);</div><div class="line">	UINT64 ret = <span class="number">1</span>;</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; y[i]; i += <span class="number">2</span>) {</div><div class="line">		ret = mul(ret, ret, z);</div><div class="line">		ret = mul(ret, ret, z);</div><div class="line">		<span class="keyword">if</span> (y[i] == <span class="string">'1'</span> &amp;&amp; y[i+<span class="number">1</span>] == <span class="string">'1'</span>) {</div><div class="line">			ret = mul(ret, x3, z);</div><div class="line">		} <span class="keyword">else</span> <span class="keyword">if</span> (y[i] == <span class="string">'1'</span> &amp;&amp; y[i+<span class="number">1</span>] == <span class="string">'0'</span>) {</div><div class="line">			ret = mul(ret, x2, z); </div><div class="line">		} <span class="keyword">else</span> <span class="keyword">if</span> (y[i+<span class="number">1</span>] == <span class="string">'1'</span>) {</div><div class="line">			ret = mul(ret, x, z);</div><div class="line">		}</div><div class="line">	}</div><div class="line">	<span class="keyword">return</span> ret;</div><div class="line">}</div><div class="line"><span class="keyword">char</span> y[(<span class="number">1</span>&lt;&lt;<span class="number">20</span>) + <span class="number">5</span>];</div><div class="line"><span class="keyword">int</span> main() {</div><div class="line">	<span class="keyword">long</span> <span class="keyword">long</span> x, z;</div><div class="line">	<span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%lld %s %lld"</span>, &amp;x, y, &amp;z) == <span class="number">3</span>) {</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"%llu\n"</span>, mpowL2R2(x, y, z));</div><div class="line">	}</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="L-to-R-sliding">L-to-R-sliding</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;bits/stdc++.h&gt; </span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> UINT64;</div><div class="line">UINT64 mul(UINT64 a, UINT64 b, UINT64 mod) { </div><div class="line">	UINT64 ret = <span class="number">0</span>; </div><div class="line">	<span class="keyword">for</span> (a = a &gt;= mod ? a%mod : a, b = b &gt;= mod ? b%mod : b; b != <span class="number">0</span>; b&gt;&gt;=<span class="number">1</span>, a &lt;&lt;= <span class="number">1</span>, a = a &gt;= mod ? a - mod : a) { </div><div class="line">		<span class="keyword">if</span> (b&amp;<span class="number">1</span>) {</div><div class="line">			ret += a;</div><div class="line">			<span class="keyword">if</span> (ret &gt;= mod) </div><div class="line">				ret -= mod;</div><div class="line">		} </div><div class="line">	} </div><div class="line">	<span class="keyword">return</span> ret; </div><div class="line">}</div><div class="line">UINT64 mpowL2RS(UINT64 x, <span class="keyword">char</span> y[], UINT64 z) {</div><div class="line">	UINT64 x3 = mul(mul(x, x, z), x, z);</div><div class="line">	UINT64 ret = <span class="number">1</span>;</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; y[i]; ) {</div><div class="line">		ret = mul(ret, ret, z);</div><div class="line">		<span class="keyword">if</span> (y[i] == <span class="string">'1'</span> &amp;&amp; y[i+<span class="number">1</span>] == <span class="string">'1'</span>) {</div><div class="line">			ret = mul(ret, ret, z);</div><div class="line">			ret = mul(ret, x3, z);</div><div class="line">			i += <span class="number">2</span>;</div><div class="line">		} <span class="keyword">else</span> <span class="keyword">if</span> (y[i] == <span class="string">'1'</span>) {</div><div class="line">			ret = mul(ret, x, z);</div><div class="line">			i ++;</div><div class="line">		} <span class="keyword">else</span> <span class="keyword">if</span> (y[i+<span class="number">1</span>] == <span class="string">'0'</span>) {</div><div class="line">			ret = mul(ret, ret, z);</div><div class="line">			i += <span class="number">2</span>; </div><div class="line">		} <span class="keyword">else</span> {</div><div class="line">			i++;</div><div class="line">		}</div><div class="line">	}</div><div class="line">	<span class="keyword">return</span> ret;</div><div class="line">}</div><div class="line"><span class="keyword">char</span> y[(<span class="number">1</span>&lt;&lt;<span class="number">20</span>) + <span class="number">5</span>];</div><div class="line"><span class="keyword">int</span> main() {</div><div class="line">	<span class="keyword">long</span> <span class="keyword">long</span> x, z;</div><div class="line">	<span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%lld %s %lld"</span>, &amp;x, y, &amp;z) == <span class="number">3</span>) {</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"%llu\n"</span>, mpowL2RS(x, y, z));</div><div class="line">	}</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="L-to-R-sliding-cheat">L-to-R-sliding-cheat</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;bits/stdc++.h&gt; </span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> UINT64;</div><div class="line">UINT64 mul(UINT64 a, UINT64 b, UINT64 mod) { </div><div class="line">	UINT64 ret = <span class="number">0</span>; </div><div class="line">	<span class="keyword">for</span> (a = a &gt;= mod ? a%mod : a, b = b &gt;= mod ? b%mod : b; b != <span class="number">0</span>; b&gt;&gt;=<span class="number">1</span>, a &lt;&lt;= <span class="number">1</span>, a = a &gt;= mod ? a - mod : a) { </div><div class="line">		<span class="keyword">if</span> (b&amp;<span class="number">1</span>) {</div><div class="line">			ret += a;</div><div class="line">			<span class="keyword">if</span> (ret &gt;= mod) </div><div class="line">				ret -= mod;</div><div class="line">		} </div><div class="line">	} </div><div class="line">	<span class="keyword">return</span> ret; </div><div class="line">}</div><div class="line"></div><div class="line">UINT64 mpowL2RS(UINT64 x, <span class="keyword">char</span> y[], UINT64 z) {</div><div class="line">	UINT64 x3 = mul(mul(x, x, z), x, z);</div><div class="line">	UINT64 ret = <span class="number">1</span>;</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; y[i]; ) {</div><div class="line">		ret = mul(ret, ret, z);</div><div class="line">		<span class="keyword">if</span> (y[i] == <span class="string">'1'</span> &amp;&amp; y[i+<span class="number">1</span>] == <span class="string">'1'</span>) {</div><div class="line">			ret = mul(ret, ret, z);</div><div class="line">			ret = mul(ret, x3, z);</div><div class="line">			i += <span class="number">2</span>;</div><div class="line">		} <span class="keyword">else</span> <span class="keyword">if</span> (y[i] == <span class="string">'1'</span>) {</div><div class="line">			ret = mul(ret, x, z);</div><div class="line">			i ++;</div><div class="line">		} <span class="keyword">else</span> <span class="keyword">if</span> (y[i+<span class="number">1</span>] == <span class="string">'0'</span>) {</div><div class="line">			ret = mul(ret, ret, z);</div><div class="line">			i += <span class="number">2</span>; </div><div class="line">		} <span class="keyword">else</span> {</div><div class="line">			i++;</div><div class="line">		}</div><div class="line">	}</div><div class="line">	<span class="keyword">return</span> ret;</div><div class="line">}</div><div class="line"><span class="preprocessor">#<span class="keyword">define</span> PREPROC 8</span></div><div class="line">UINT64 mpowCHEAT(UINT64 x, <span class="keyword">char</span> y[], UINT64 z) {</div><div class="line">	<span class="keyword">int</span> n;</div><div class="line">	<span class="keyword">for</span> (n = <span class="number">1</span>; y[n]; n &lt;&lt;= <span class="number">1</span>);</div><div class="line">	<span class="keyword">if</span> (n &lt; <span class="number">1</span>&lt;&lt;PREPROC)</div><div class="line">		<span class="keyword">return</span> mpowL2RS(x, y, z);</div><div class="line">	UINT64 X[<span class="number">1</span>&lt;&lt;PREPROC] = {<span class="number">1</span>};</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; (<span class="number">1</span>&lt;&lt;PREPROC); i++)</div><div class="line">		X[i] = mul(X[i-<span class="number">1</span>], x, z);</div><div class="line">	UINT64 ret = <span class="number">1</span>;</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, v; y[i]; i += PREPROC) {</div><div class="line">		ret = mul(ret, ret, z);</div><div class="line">		ret = mul(ret, ret, z);</div><div class="line">		ret = mul(ret, ret, z);</div><div class="line">		ret = mul(ret, ret, z);</div><div class="line">		ret = mul(ret, ret, z);</div><div class="line">		ret = mul(ret, ret, z);</div><div class="line">		ret = mul(ret, ret, z);</div><div class="line">		ret = mul(ret, ret, z);</div><div class="line">		v = (y[i]-<span class="string">'0'</span>)&lt;&lt;<span class="number">7</span>|(y[i+<span class="number">1</span>]-<span class="string">'0'</span>)&lt;&lt;<span class="number">6</span>|(y[i+<span class="number">2</span>]-<span class="string">'0'</span>)&lt;&lt;<span class="number">5</span>|(y[i+<span class="number">3</span>]-<span class="string">'0'</span>)&lt;&lt;<span class="number">4</span>|(y[i+<span class="number">4</span>]-<span class="string">'0'</span>)&lt;&lt;<span class="number">3</span>|(y[i+<span class="number">5</span>]-<span class="string">'0'</span>)&lt;&lt;<span class="number">2</span>|(y[i+<span class="number">6</span>]-<span class="string">'0'</span>)&lt;&lt;<span class="number">1</span>|(y[i+<span class="number">7</span>]-<span class="string">'0'</span>); </div><div class="line">		ret = mul(ret, X[v], z);</div><div class="line">	}</div><div class="line">	<span class="keyword">return</span> ret;</div><div class="line">}</div><div class="line"><span class="keyword">char</span> y[(<span class="number">1</span>&lt;&lt;<span class="number">20</span>) + <span class="number">5</span>];</div><div class="line"><span class="keyword">int</span> main() {</div><div class="line">	<span class="keyword">long</span> <span class="keyword">long</span> x, z;</div><div class="line">	<span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%lld %s %lld"</span>, &amp;x, y, &amp;z) == <span class="number">3</span>) {</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"%llu\n"</span>, mpowCHEAT(x, y, z));</div><div class="line">	}</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-b440" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/07/12/zj-b440/" class="article-date">
  <time datetime="2015-07-12T07:53:49.000Z" itemprop="datePublished">Jul 12 2015</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>►<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/07/12/zj-b440/">b440. 互質對</a>
    </h1>
  

      </header>
        
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/07/12/zj-b440/" data-id="go2s7jxrhdl4cisz" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/07/12/zj-b440/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/分塊/">分塊</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/數論基礎/">數論基礎</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/莫比烏斯反演/">莫比烏斯反演</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem">Problem</h2>
<p>給定 $n$ 和 $m$，請你統計有序對 $(a,b)$ 的個數，其中 $1 \le a \le n, 1 \le b \le m$ 且 $a$ 與 $b$ 互質。</p>
<p>$a$ 與 $b$ 互質的定義是：$a$ 與 $b$ 的最大公約數等於 $1$。</p>
<blockquote>
<p>count coprime pair</p>
</blockquote>
<h2 id="Sample_Input">Sample Input</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">2</div><div class="line">3 4</div><div class="line">10000000 10000000</div></pre></td></tr></table></figure>

<h2 id="Sample_Output">Sample Output</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">9</div><div class="line">60792712854483</div></pre></td></tr></table></figure>

<h2 id="Solution">Solution</h2>
<h3 id="前言">前言</h3>
<p>柳柳州出數論基礎－「莫比烏斯反演 (Möbius inversion formula)」</p>
<p>之前放棄看完的內容又要撿回來看，百般痛苦，之前沒看懂啊。但能知道的是莫比烏斯反演類似排容原理，就像錯排依樣。先不管莫比烏斯，看到「線性時間求出所有乘法反元素」真的可以嗎？那也是件很有趣的事情。</p>
<h3 id="參考資源">參考資源</h3>
<ul>
<li>莫比烏斯參考《線性篩法與積性函數》－賈志鵬 <a href="http://wenku.baidu.com/view/542961fdba0d4a7302763ad5.html" target="_blank" rel="external">link</a></li>
<li>分塊優化參考《POI XIV Stage.1 Queries Zap 解题报告》－Kwc Oliver <a href="http://wenku.baidu.com/view/fbe263d384254b35eefd34eb.html" target="_blank" rel="external">link</a></li>
</ul>
<h3 id="基礎定義">基礎定義</h3>
<p>了解莫比烏斯反演之前，要先介紹積性函數</p>
<h4 id="積性函數">積性函數</h4>
<ul>
<li>何謂積性函數 (Multiplicative function)？<br>對於定義域 $\mathbb{N}^+$ 的函數 $f$ 而言，任兩個互質的 $gcd(a, b) = 1$ 正整數 $a, b$ 滿足 $f(ab) = f(a)f(b)$。</li>
<li>何謂完全積性函數？<br>$f$ 是一個積性函數，同時滿足 $f(p^n) = f(p)^n$。</li>
<li>若 $f(n), g(n)$ 是積性函數，則 $h(n) = f(n) g(n)$ 也是積性函數。</li>
<li>若 $f(n)$ 為積性函數，則函數 $g(n) = \sum_{d|n} f(d)$ 也是積性函數。</li>
</ul>
<h4 id="歐拉函數">歐拉函數</h4>
<p>回顧歐拉函數 (Euler’s totient function) $\phi$</p>
<ul>
<li>定義 $\phi(n)$ 為 $1 \cdots n$ 中與 $n$ 互質的個數。</li>
<li><p>$\phi(n)$ 是一個積性函數，但不是完全積性函數。根據中國餘數定理 或者 基本算術可以證明之。</p>
</li>
<li><p>歐拉定理 $a^{\phi(n)} \equiv 1 \mod n, \text{ when } gcd(a, n) = 1$。</p>
</li>
<li><p>特性 1：$\sum_{d|n} \phi(d) = n$。當作把互質個數 $\phi(n)$ 相加不互質個數 $s$，由於 $d$ 是 $n$ 的因數，則與 $d$ 互質 $x$ 個數 $\phi(d)$，把那些 $x’ = x \times d/n$ 就會補上那些不互質的個數 $s = |set(x’)|$。</p>
</li>
<li><p>特性 2：$1 \cdots n$ 與 $n$ 互質的數和為 $n\phi(n)/2$。原因很簡單，若 $gcd(x, n) = 1$，則會滿足 $gcd(n-x, n) = 1$，看起來就是一個對稱總和。</p>
</li>
</ul>
<h4 id="莫比烏斯">莫比烏斯</h4>
<p>根據積性函數的性質，我們得到莫比烏斯反演的基礎：</p>
<p>莫比烏斯反演公式 $f(n)$</p>
<span>$$f(n) = \sum_{d|n} \mu(d) g(\frac{n}{d})$$</span>

<p>莫比烏斯函數 $\mu(n)$</p>
<span>$$\mu(n) = \left\{\begin{matrix}
1 && n = 1\\
(-1)^k && n = p_1 p_2 \cdots p_k \\
0 && \text{otherwise}
\end{matrix}\right.$$</span>

<ul>
<li>特性 1：$\sum_{d|n} \mu(d) = [n = 1]$</li>
</ul>
<p>在此簡單說一次，莫比烏斯反演公式就像排容原理，而莫比烏斯函數 $\mu(n)$ 就像一加一減，之所以在 $n = p_1 p_2 \cdots p_k$ 為 $\mu(n) = (-1)^k$，也就是說當 $n$ 只全由質數相乘 (不允許冪次方大於 1，否則為 0)，相當於一般認知，奇數次要扣，偶數次要補回來的排容口訣。而特定自然不必多說，其中數學表達 $[n = 1]$ 相當於程式中的 <code>n == 1 ? 1 : 0</code>。</p>
<p>簡單展示歐拉函數 $\phi(n)$</p>
<ul>
<li>$f(n) = \sum_{d|n} \phi(d) = n$，由歐拉函數特性 2 得知。</li>
<li><span>$\phi(n) = \sum_{d|n} \mu(d) f(\frac{n}{d}) = \sum_{d|n} \frac{\mu(d) n}{d}$</span>，套用莫比烏斯公式後整理。</li>
</ul>
<p>關於公式 <span>$\phi(n) = \sum_{d|n} \frac{\mu(d) n}{d}$</span> 可以這麼理解。</p>
<ul>
<li>求出 $gcd(n, k) = 1$ 的個數，其餘要捨棄掉。</li>
<li>計算 $gcd(n, k) = d$ 的個數，利用排容原理即莫比烏斯函數，顯而易見排容方案只當 $d$ 為 $n$ 個質因數組合而成。</li>
</ul>
<h3 id="應用此題">應用此題</h3>
<p>利用莫比烏斯函數 特性 1：$\sum_{d|n} \mu(d) = [n = 1]$</p>
<span>$$\begin{align*}
& \sum_{a = 1}^{N} \sum_{b = 1}^{M} [gcd(a, b) = 1] \\
& = \sum_{a = 1}^{N} \sum_{b = 1}^{M} \sum_{d|gcd(a, b)} \mu(d) \\
& = \sum \mu(d) \left ( \sum_{1 \le a \le N \text{ and } d | a} \left ( \sum_{1 \le b \le M \text{ and } d | b} 1 \right ) \right )\\
& = \sum \mu(d) \left \lfloor \frac{n}{d} \right \rfloor \left \lfloor \frac{m}{d} \right \rfloor
\end{align*}$$</span>

<p>第二行就是抽換莫比烏斯，第三行則是交換順序，第四行則是可以快速找到 $d|a$ 的總數為 $\lfloor n/d \rfloor$ 所導致。</p>
<p>若直接窮舉 $d$ 時間複雜度為 $O(min(n, m))$，可以利用塊狀的概念優化到 $O(\sqrt{n} + \sqrt{m})$。因為 $\lfloor n/d \rfloor$ 的值只有 $2\lfloor \sqrt{n} \rfloor$ 種可能，同理 $\lfloor m/d \rfloor$ 也是，那麼對於同一個 $d$ 的計數會是一個連續區間不斷地移動。</p>
<p>以下是一個簡單的 $\lfloor n/d \rfloor$ 示意圖，用 $\lfloor n/d \rfloor$ 不同當作劃分。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">                 <span class="comment">X</span>  <span class="comment">X</span>        <span class="comment">X</span>     <span class="comment">X</span> <span class="comment">X</span>   <span class="comment">X</span>  <span class="comment">X</span> <span class="comment">XX</span>  <span class="comment">X</span>  <span class="comment">X</span>                        </div><div class="line">                 <span class="comment">X</span>  <span class="comment">X</span>        <span class="comment">X</span>     <span class="comment">X</span> <span class="comment">X</span>   <span class="comment">X</span>  <span class="comment">X</span> <span class="comment">XX</span>  <span class="comment">X</span>  <span class="comment">X</span>                        </div><div class="line"><span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>                        </div><div class="line"><span class="comment">|</span>                <span class="comment">|</span>           <span class="comment">|</span>       <span class="comment">|</span>   <span class="comment">|</span>  <span class="comment">|</span>  <span class="comment">|</span>  <span class="comment">|</span>  <span class="comment">|</span> <span class="comment">n</span>                        </div><div class="line"><span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>                        </div><div class="line"><span class="comment">012345678901234567890123456789012345678901234567890123</span></div><div class="line"><span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span> </div><div class="line"><span class="comment">|</span>                   <span class="comment">|</span>              <span class="comment">|</span>          <span class="comment">|</span>      <span class="comment">|</span>   <span class="comment">|</span>   <span class="comment">|</span>  <span class="comment">|</span>  <span class="comment">|</span>  <span class="comment">|</span>  <span class="comment">|</span>  <span class="comment">|</span> <span class="comment">m</span></div><div class="line"><span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span> </div><div class="line">                 <span class="comment">X</span>  <span class="comment">X</span>        <span class="comment">X</span>     <span class="comment">X</span> <span class="comment">X</span>   <span class="comment">X</span>  <span class="comment">X</span> <span class="comment">XX</span>  <span class="comment">X</span>  <span class="comment">X</span>                        </div><div class="line">                 <span class="comment">X</span>  <span class="comment">X</span>        <span class="comment">X</span>     <span class="comment">X</span> <span class="comment">X</span>   <span class="comment">X</span>  <span class="comment">X</span> <span class="comment">XX</span>  <span class="comment">X</span>  <span class="comment">X</span></div></pre></td></tr></table></figure>

<p>程式只要處理打 <code>X</code> 的位置即可，時間複雜度 $O(\sqrt{n} + \sqrt{m})$，可以參照一般解。代碼短，但除法次數多。</p>
<p>加速一般解由 liouzhou_101 提供。開一次根號 <code>sqrt()</code>，省下 $O(\sqrt{n})$ 次的除法，賺了 400 ms，代碼長了 800 B。加速 25% 的效能，可謂除法的可怕，根據研究差異後才發現到這一點。</p>
<h3 id="一般解">一般解</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;bits/stdc++.h&gt; </span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="preprocessor">#<span class="keyword">define</span> GET(x) (mark[(x)&gt;&gt;5]&gt;&gt;((x)&amp;31)&amp;1)</span></div><div class="line"><span class="preprocessor">#<span class="keyword">define</span> SET(x) (mark[(x)&gt;&gt;5] |= 1&lt;&lt;((x)&amp;31))</span></div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">10000005</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXL = (MAXN&gt;&gt;<span class="number">5</span>)+<span class="number">1</span>;</div><div class="line"><span class="keyword">int</span> mark[MAXL];</div><div class="line"><span class="keyword">int</span> P[<span class="number">700000</span>], Pt = <span class="number">0</span>;</div><div class="line"><span class="keyword">short</span> mu[MAXN], sum[MAXN];</div><div class="line"><span class="keyword">void</span> sieve_mobius() {</div><div class="line">	<span class="keyword">register</span> <span class="keyword">int</span> i, j, k;</div><div class="line">	SET(<span class="number">1</span>), mu[<span class="number">1</span>] = <span class="number">1</span>;</div><div class="line">	<span class="keyword">int</span> n = <span class="number">10000000</span>;</div><div class="line">	<span class="keyword">for</span> (i = <span class="number">2</span>; i &lt;= n; i++) {</div><div class="line">		<span class="keyword">if</span> (!GET(i))</div><div class="line">			P[Pt++] = i, mu[i] = -<span class="number">1</span>;</div><div class="line">		<span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; Pt &amp;&amp; (k = i*P[j]) &lt;= n; j++) {</div><div class="line">			SET(k);</div><div class="line">			<span class="keyword">if</span> (i%P[j] == <span class="number">0</span>) {</div><div class="line">				mu[k] = <span class="number">0</span>;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			} </div><div class="line">			mu[k] = -mu[i];</div><div class="line">		}</div><div class="line">	}</div><div class="line">}</div><div class="line"><span class="keyword">long</span> <span class="keyword">long</span> coprime_pair(<span class="keyword">int</span> n, <span class="keyword">int</span> m) {</div><div class="line">	<span class="keyword">long</span> <span class="keyword">long</span> ret = <span class="number">0</span>;</div><div class="line">	<span class="keyword">if</span> (n &gt; m)	swap(n, m);</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> d = <span class="number">1</span>, r; d &lt;= n; d = r+<span class="number">1</span>) {</div><div class="line">		r = min(n / (n/d), m / (m/d));</div><div class="line">		ret += (<span class="keyword">long</span> <span class="keyword">long</span>)(sum[r] - sum[d-<span class="number">1</span>]) * (n/d) * (m/d);</div><div class="line">	}</div><div class="line">	<span class="keyword">return</span> ret;</div><div class="line">}</div><div class="line"><span class="keyword">int</span> main() {</div><div class="line">	sieve_mobius();</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; MAXN; i++)</div><div class="line">		sum[i] = sum[i-<span class="number">1</span>] + mu[i];</div><div class="line">	<span class="keyword">int</span> testcase, N, M;</div><div class="line">	<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;testcase);</div><div class="line">	<span class="keyword">while</span> (testcase--) {</div><div class="line">		<span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;N, &amp;M);</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"%lld\n"</span>, coprime_pair(N, M));</div><div class="line">	}</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="加速運算解">加速運算解</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;bits/stdc++.h&gt; </span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="preprocessor">#<span class="keyword">define</span> GET(x) (mark[(x)&gt;&gt;5]&gt;&gt;((x)&amp;31)&amp;1)</span></div><div class="line"><span class="preprocessor">#<span class="keyword">define</span> SET(x) (mark[(x)&gt;&gt;5] |= 1&lt;&lt;((x)&amp;31))</span></div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">10000005</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> SQRN = <span class="number">3200</span> * <span class="number">2</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXL = (MAXN&gt;&gt;<span class="number">5</span>)+<span class="number">1</span>;</div><div class="line"><span class="keyword">int</span> mark[MAXL];</div><div class="line"><span class="keyword">int</span> P[<span class="number">700000</span>], Pt = <span class="number">0</span>;</div><div class="line"><span class="keyword">short</span> mu[MAXN], sum[MAXN];</div><div class="line"><span class="keyword">void</span> sieve_mobius() {</div><div class="line">	<span class="keyword">register</span> <span class="keyword">int</span> i, j, k;</div><div class="line">	SET(<span class="number">1</span>), mu[<span class="number">1</span>] = <span class="number">1</span>;</div><div class="line">	<span class="keyword">int</span> n = <span class="number">10000000</span>;</div><div class="line">	<span class="keyword">for</span> (i = <span class="number">2</span>; i &lt;= n; i++) {</div><div class="line">		<span class="keyword">if</span> (!GET(i))</div><div class="line">			P[Pt++] = i, mu[i] = -<span class="number">1</span>;</div><div class="line">		<span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; Pt &amp;&amp; (k = i*P[j]) &lt;= n; j++) {</div><div class="line">			SET(k);</div><div class="line">			<span class="keyword">if</span> (i%P[j] == <span class="number">0</span>) {</div><div class="line">				mu[k] = <span class="number">0</span>;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			} </div><div class="line">			mu[k] = -mu[i];</div><div class="line">		}</div><div class="line">	}</div><div class="line">}</div><div class="line"><span class="keyword">long</span> <span class="keyword">long</span> coprime_pair(<span class="keyword">int</span> n, <span class="keyword">int</span> m) {</div><div class="line">	<span class="keyword">static</span> <span class="keyword">int</span> An[SQRN][<span class="number">2</span>], Bn[SQRN][<span class="number">2</span>];</div><div class="line">	<span class="keyword">if</span> (n &gt; m)	swap(n, m);</div><div class="line">	<span class="keyword">long</span> <span class="keyword">long</span> ret = <span class="number">0</span>;</div><div class="line">	<span class="keyword">int</span> aidx = <span class="number">0</span>, bidx = <span class="number">0</span>, sq;</div><div class="line">	sq = <span class="built_in">sqrt</span>(n);</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= sq; i++, aidx++)	An[aidx][<span class="number">1</span>] = n/(An[aidx][<span class="number">0</span>] = n / i);</div><div class="line">	<span class="keyword">if</span> (sq * sq == n)	aidx--;</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = sq; i &gt;= <span class="number">1</span>; i--, aidx++)	An[aidx][<span class="number">1</span>] = n/(An[aidx][<span class="number">0</span>] = i);</div><div class="line">	sq = <span class="built_in">sqrt</span>(m);</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= sq; i++, bidx++)	Bn[bidx][<span class="number">1</span>] = m/(Bn[bidx][<span class="number">0</span>] = m / i);</div><div class="line">	<span class="keyword">if</span> (sq * sq == m)	bidx--;</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = sq; i &gt;= <span class="number">1</span>; i--, bidx++)	Bn[bidx][<span class="number">1</span>] = m/(Bn[bidx][<span class="number">0</span>] = i);</div><div class="line">	</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">1</span>, r, *a = &amp;An[<span class="number">0</span>][<span class="number">1</span>], *b = &amp;Bn[<span class="number">0</span>][<span class="number">1</span>], *A = &amp;An[<span class="number">0</span>][<span class="number">0</span>], *B = &amp;Bn[<span class="number">0</span>][<span class="number">0</span>]; l &lt;= n; l = r+<span class="number">1</span>) {</div><div class="line">		<span class="keyword">if</span> (*a &lt; *b)</div><div class="line">			r = *a, ret += (<span class="keyword">long</span> <span class="keyword">long</span>) (sum[r] - sum[l-<span class="number">1</span>]) * *A * *B, A+=<span class="number">2</span>, a+=<span class="number">2</span>;</div><div class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (*a &gt; *b)</div><div class="line">			r = *b, ret += (<span class="keyword">long</span> <span class="keyword">long</span>) (sum[r] - sum[l-<span class="number">1</span>]) * *A * *B, B+=<span class="number">2</span>, b+=<span class="number">2</span>;</div><div class="line">		<span class="keyword">else</span></div><div class="line">			r = *a, ret += (<span class="keyword">long</span> <span class="keyword">long</span>) (sum[r] - sum[l-<span class="number">1</span>]) * *A * *B, A+=<span class="number">2</span>, B+=<span class="number">2</span>, a+=<span class="number">2</span>, b+=<span class="number">2</span>;</div><div class="line">	}</div><div class="line">	<span class="keyword">return</span> ret;</div><div class="line">}</div><div class="line"><span class="keyword">int</span> main() {</div><div class="line">	sieve_mobius();</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; MAXN; i++)</div><div class="line">		sum[i] = sum[i-<span class="number">1</span>] + mu[i];</div><div class="line">	<span class="keyword">int</span> testcase, N, M;</div><div class="line">	<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;testcase);</div><div class="line">	<span class="keyword">while</span> (testcase--) {</div><div class="line">		<span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;N, &amp;M);</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"%lld\n"</span>, coprime_pair(N, M));</div><div class="line">	}</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-b441" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/07/12/zj-b441/" class="article-date">
  <time datetime="2015-07-12T07:39:05.000Z" itemprop="datePublished">Jul 12 2015</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>►<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/07/12/zj-b441/">b441. 延展尺寸</a>
    </h1>
  

      </header>
        
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/07/12/zj-b441/" data-id="1jkef4uv3a3kdi5n" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/07/12/zj-b441/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dp/">dp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/影像處理/">影像處理</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/模擬/">模擬</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem">Problem</h2>
<p>將 N 張小正方形拼成長條圖，並且每一次挑選一個正方形區域黏貼在長條後，黏貼的條件是比較重疊一半的區域，利用能量最少路徑進行裁剪後併在一起。</p>
<p>如果最少能量大於等於某個值，則再隨機挑選一個正方形區域進行黏貼，捨棄掉這次黏貼操作，若嘗試 50 次沒有成功低於閥值，則取消全部的黏貼操作。</p>
<p>當初的問題在於 <strong> 連續 50 次 </strong> 看得似懂非懂，然後還以為是要碎形圖，只找一個正方形去重疊得到 N 個。</p>
<h2 id="Sample_Input">Sample Input</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">2 1</div><div class="line">2 2</div><div class="line">1 2 3 4 5 6</div><div class="line">7 8 9 10 11 12</div></pre></td></tr></table></figure>

<h2 id="Sample_Output">Sample Output</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">2 2</div><div class="line">1 2 3 4 5 6</div><div class="line">7 8 9 10 11 12</div></pre></td></tr></table></figure>

<h2 id="Solution">Solution</h2>
<p>接續上一題 b438. 裁剪尺寸 的作法，現在多一個串接和重疊的操作。</p>
<p>感謝蔡星 asas 對此題描述的解說。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;bits/stdc++.h&gt; </span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="keyword">class</span> IMAGE {</div><div class="line"><span class="keyword">public</span>:</div><div class="line">	<span class="keyword">struct</span> Pixel {</div><div class="line">		<span class="keyword">int</span> r, g, b;</div><div class="line">		Pixel(<span class="keyword">int</span> x = <span class="number">0</span>, <span class="keyword">int</span> y = <span class="number">0</span>, <span class="keyword">int</span> z = <span class="number">0</span>):</div><div class="line">			r(x), g(y), b(z) {}</div><div class="line">		<span class="keyword">void</span> read() {</div><div class="line">			<span class="built_in">scanf</span>(<span class="string">"%d %d %d"</span>, &amp;r, &amp;g, &amp;b);</div><div class="line">		}</div><div class="line">		Pixel <span class="keyword">operator</span>-(<span class="keyword">const</span> Pixel &amp;x) <span class="keyword">const</span> {</div><div class="line">        	<span class="keyword">return</span> Pixel(r-x.r, g-x.g, b-x.b);</div><div class="line">    	}</div><div class="line">    	Pixel <span class="keyword">operator</span>+(<span class="keyword">const</span> Pixel &amp;x) <span class="keyword">const</span> {</div><div class="line">        	<span class="keyword">return</span> Pixel(r+x.r, g+x.g, b+x.b);</div><div class="line">    	}</div><div class="line">    	Pixel <span class="keyword">operator</span>*(<span class="keyword">const</span> <span class="keyword">double</span> x) <span class="keyword">const</span> {</div><div class="line">        	<span class="keyword">return</span> Pixel(r*x, g*x, b*x);</div><div class="line">    	}</div><div class="line">		Pixel <span class="keyword">operator</span>/(<span class="keyword">const</span> <span class="keyword">double</span> x) <span class="keyword">const</span> {</div><div class="line">        	<span class="keyword">return</span> Pixel(r/x, g/x, b/x);</div><div class="line">    	}</div><div class="line">    	<span class="keyword">void</span> print() {</div><div class="line">    		<span class="built_in">printf</span>(<span class="string">"%d %d %d"</span>, r, g, b);</div><div class="line">    	}</div><div class="line">    	<span class="keyword">int</span> length() {</div><div class="line">    		<span class="keyword">return</span> <span class="built_in">abs</span>(r) + <span class="built_in">abs</span>(g) + <span class="built_in">abs</span>(b);</div><div class="line">    	}</div><div class="line">    	<span class="keyword">double</span> dist(Pixel x) {</div><div class="line">    		<span class="keyword">return</span> <span class="built_in">sqrt</span>((r-x.r)*(r-x.r)+(g-x.g)*(g-x.g)+(b-x.b)*(b-x.b));</div><div class="line">    	}</div><div class="line">	};</div><div class="line">	<span class="keyword">int</span> W, H;</div><div class="line">	<span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">256</span>;</div><div class="line">	Pixel data[MAXN][MAXN*<span class="number">3</span>], tmp[MAXN][MAXN*<span class="number">3</span>];</div><div class="line">	<span class="keyword">int</span> energy[MAXN][MAXN], dp[MAXN][MAXN];</div><div class="line">	<span class="keyword">long</span> <span class="keyword">long</span> seed;</div><div class="line">	<span class="keyword">int</span> random() {</div><div class="line">    	<span class="keyword">return</span> seed = ( seed * <span class="number">9301</span> + <span class="number">49297</span> ) % <span class="number">233280</span>;</div><div class="line">	}</div><div class="line">	<span class="keyword">void</span> getSquarePosition(<span class="keyword">int</span> &amp;x, <span class="keyword">int</span> &amp;y, <span class="keyword">int</span> L) {</div><div class="line"> 		y = (W &lt;= L) ? <span class="number">0</span> : random() % (W - L);</div><div class="line">    	x = (H &lt;= L) ? <span class="number">0</span> : random() % (H - L); </div><div class="line">	} </div><div class="line">	<span class="keyword">void</span> read() {</div><div class="line">		<span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;W, &amp;H);</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; H; i++)</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; W; j++)</div><div class="line">				data[i][j].read();</div><div class="line">		seed = <span class="number">0</span>;</div><div class="line">	}</div><div class="line">	<span class="keyword">int</span> isValid(<span class="keyword">int</span> x, <span class="keyword">int</span> y) {</div><div class="line">		<span class="keyword">return</span> x &gt;= <span class="number">0</span> &amp;&amp; y &gt;= <span class="number">0</span> &amp;&amp; x &lt; H &amp;&amp; y &lt; W;</div><div class="line">	}</div><div class="line">	<span class="keyword">void</span> pattern(<span class="keyword">int</span> L, <span class="keyword">int</span> N) {</div><div class="line">		<span class="keyword">int</span> ERROR_TRY = <span class="number">50</span>;</div><div class="line">		<span class="keyword">int</span> threshold = round(L*<span class="number">255</span>/<span class="number">8.0</span>);</div><div class="line">		<span class="keyword">int</span> overlap = round(L/<span class="number">2.0</span>);</div><div class="line">		<span class="keyword">int</span> lx, ly, tW = <span class="number">0</span>, path[MAXN] = {};</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> n = <span class="number">0</span>, it; n &lt; N; n++) {</div><div class="line">			<span class="keyword">for</span> (it = <span class="number">0</span>; it &lt; ERROR_TRY; it++) {</div><div class="line">				getSquarePosition(lx, ly, L);</div><div class="line">				<span class="keyword">if</span> (n == <span class="number">0</span>) {</div><div class="line">					<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; L; i++)</div><div class="line">						<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; L; j++)</div><div class="line">							tmp[i][j] = data[lx+i][ly+j];</div><div class="line">					tW = L;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				}</div><div class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; L; i++) {</div><div class="line">					<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; overlap; j++) {</div><div class="line">						energy[i][j] = round(data[lx+i][ly+j].dist(tmp[i][tW-overlap+j]));</div><div class="line">					}</div><div class="line">				}</div><div class="line">				<span class="keyword">int</span> cost = shrink(path, L, overlap);</div><div class="line">				<span class="keyword">if</span> (cost &lt; threshold) {</div><div class="line">					<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; L; i++) {</div><div class="line">						<span class="keyword">for</span> (<span class="keyword">int</span> j = L-<span class="number">1</span>; j &gt;= path[i]; j--)</div><div class="line">							tmp[i][tW-overlap+j] = data[lx+i][ly+j];</div><div class="line">					}</div><div class="line">					tW += L - overlap;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				}</div><div class="line">			}</div><div class="line">			<span class="keyword">if</span> (it == ERROR_TRY)</div><div class="line">				<span class="keyword">return</span> ;</div><div class="line">		}</div><div class="line">		W = tW, H = L;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; H; i++)</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; W; j++)</div><div class="line">				data[i][j] = tmp[i][j];</div><div class="line">	}</div><div class="line">	<span class="keyword">int</span> shrink(<span class="keyword">int</span> path[], <span class="keyword">int</span> H, <span class="keyword">int</span> W) {</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; H; i++) {</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; W; j++) {</div><div class="line">				<span class="keyword">int</span> &amp;val = dp[i][j];</div><div class="line">				<span class="keyword">if</span> (i == <span class="number">0</span>)	val = energy[i][j];</div><div class="line">				<span class="keyword">else</span> {	</div><div class="line">					val = dp[i-<span class="number">1</span>][j];</div><div class="line">					<span class="keyword">if</span> (j-<span class="number">1</span> &gt;= <span class="number">0</span>)</div><div class="line">						val = min(val, dp[i-<span class="number">1</span>][j-<span class="number">1</span>]);</div><div class="line">					<span class="keyword">if</span> (j+<span class="number">1</span> &lt; W)</div><div class="line">						val = min(val, dp[i-<span class="number">1</span>][j+<span class="number">1</span>]);</div><div class="line">					val += energy[i][j];</div><div class="line">				}</div><div class="line">			}</div><div class="line">		}</div><div class="line">		<span class="keyword">int</span> st = <span class="number">0</span>, cost;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; W; i++)</div><div class="line">			<span class="keyword">if</span> (dp[H-<span class="number">1</span>][i] &lt; dp[H-<span class="number">1</span>][st])</div><div class="line">				st = i;</div><div class="line">		cost = dp[H-<span class="number">1</span>][st];</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = H-<span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) {</div><div class="line">			path[i] = st;</div><div class="line">			<span class="keyword">if</span> (i == <span class="number">0</span>)	<span class="keyword">continue</span>;</div><div class="line">			<span class="keyword">int</span> val = dp[i][st] - energy[i][st];</div><div class="line">			<span class="keyword">if</span> (st-<span class="number">1</span> &gt;= <span class="number">0</span> &amp;&amp; val == dp[i-<span class="number">1</span>][st-<span class="number">1</span>])</div><div class="line">				st = st-<span class="number">1</span>;</div><div class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (val == dp[i-<span class="number">1</span>][st])</div><div class="line">				st = st;</div><div class="line">			<span class="keyword">else</span></div><div class="line">				st = st+<span class="number">1</span>;</div><div class="line">		}</div><div class="line">		<span class="keyword">return</span> cost;</div><div class="line">	}</div><div class="line">	<span class="keyword">void</span> print() {</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"%d %d\n"</span>, W, H);</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; H; i++)</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; W; j++)</div><div class="line">				data[i][j].print(), <span class="built_in">printf</span>(<span class="string">"%c"</span>, j == W-<span class="number">1</span> ? <span class="string">'\n'</span> : <span class="string">' '</span>);</div><div class="line">	}</div><div class="line">} test;</div><div class="line"><span class="keyword">int</span> main() {</div><div class="line">	<span class="keyword">int</span> n, L, N;</div><div class="line">	<span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;L, &amp;N);</div><div class="line">	test.read();</div><div class="line">	test.pattern(L, N);</div><div class="line">	test.print();</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-b438" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/07/12/zj-b438/" class="article-date">
  <time datetime="2015-07-12T07:27:55.000Z" itemprop="datePublished">Jul 12 2015</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>►<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/07/12/zj-b438/">b438. 裁剪尺寸</a>
    </h1>
  

      </header>
        
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/07/12/zj-b438/" data-id="o1m8vjofus3tyule" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/07/12/zj-b438/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dp/">dp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/影像處理/">影像處理</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/模擬/">模擬</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem">Problem</h2>
<p>要讓影像的寬度減少，其一的方案就是每一列刪除一個像素，為了讓刪除更加地完善、盡可能看不出來突兀的地方，採用一個一條由上而下路徑進行刪除。</p>
<p>刪除路徑採用最少費用，這個費用採用 sobel operator，也就是說費用越高表示可能是邊緣像素，減少突兀就是盡可能不要去刪除到邊緣像素，這是顯而易見的方案。接著就是採用貪心方案，依序刪除 n 次路徑。</p>
<h2 id="Sample_Input">Sample Input</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">0</div><div class="line">1 1</div><div class="line">255 255 255</div></pre></td></tr></table></figure>

<h2 id="Sample_Output">Sample Output</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">1 1</div><div class="line">255 255 255</div></pre></td></tr></table></figure>

<h2 id="Solution">Solution</h2>
<p>題目說明最好的選擇方案是一次 n 條不相交的由上而下的路徑，但這個定義是總花費，還是最小化最大花費路徑這是有疑惑的，若單純總花費可以採用最小費用流去完成，但複雜度對這個影像處理會可怕，點數跟邊數都是破萬，複雜度 $O(VE)$ 的算法要跑非常久，因此貪心是個好選擇。</p>
<p>找尋花費最小的路徑是採用 dynamic programming 的方式得到，並且要回溯得到左側最小的一條路徑。每刪除一條路徑後，sobel operator 要重新計算每一個像素的異動，刷新這一塊可以指更動路徑的右側和鄰近路徑的像素即可，這可以大幅度地增加速度。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;bits/stdc++.h&gt; </span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="keyword">class</span> IMAGE {</div><div class="line"><span class="keyword">public</span>:</div><div class="line">	<span class="keyword">struct</span> Pixel {</div><div class="line">		<span class="keyword">int</span> r, g, b;</div><div class="line">		Pixel(<span class="keyword">int</span> x = <span class="number">0</span>, <span class="keyword">int</span> y = <span class="number">0</span>, <span class="keyword">int</span> z = <span class="number">0</span>):</div><div class="line">			r(x), g(y), b(z) {}</div><div class="line">		<span class="keyword">void</span> read() {</div><div class="line">			<span class="built_in">scanf</span>(<span class="string">"%d %d %d"</span>, &amp;r, &amp;g, &amp;b);</div><div class="line">		}</div><div class="line">		Pixel <span class="keyword">operator</span>-(<span class="keyword">const</span> Pixel &amp;x) <span class="keyword">const</span> {</div><div class="line">        	<span class="keyword">return</span> Pixel(r-x.r, g-x.g, b-x.b);</div><div class="line">    	}</div><div class="line">    	Pixel <span class="keyword">operator</span>+(<span class="keyword">const</span> Pixel &amp;x) <span class="keyword">const</span> {</div><div class="line">        	<span class="keyword">return</span> Pixel(r+x.r, g+x.g, b+x.b);</div><div class="line">    	}</div><div class="line">    	Pixel <span class="keyword">operator</span>*(<span class="keyword">const</span> <span class="keyword">int</span> x) <span class="keyword">const</span> {</div><div class="line">        	<span class="keyword">return</span> Pixel(r*x, g*x, b*x);</div><div class="line">    	}</div><div class="line">		Pixel <span class="keyword">operator</span>/(<span class="keyword">const</span> <span class="keyword">int</span> x) <span class="keyword">const</span> {</div><div class="line">        	<span class="keyword">return</span> Pixel(r/x, g/x, b/x);</div><div class="line">    	}</div><div class="line">    	<span class="keyword">void</span> print() {</div><div class="line">    		<span class="built_in">printf</span>(<span class="string">"%d %d %d"</span>, r, g, b);</div><div class="line">    	}</div><div class="line">    	<span class="keyword">int</span> length() {</div><div class="line">    		<span class="keyword">return</span> <span class="built_in">abs</span>(r) + <span class="built_in">abs</span>(g) + <span class="built_in">abs</span>(b);</div><div class="line">    	}</div><div class="line">	};</div><div class="line">	<span class="keyword">int</span> W, H;</div><div class="line">	<span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">256</span>;</div><div class="line">	Pixel data[MAXN][MAXN];</div><div class="line">	<span class="keyword">int</span> energy[MAXN][MAXN], dp[MAXN][MAXN];</div><div class="line">	<span class="keyword">void</span> read() {</div><div class="line">		<span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;W, &amp;H);</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; H; i++)</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; W; j++)</div><div class="line">				data[i][j].read();</div><div class="line">	}</div><div class="line">	Pixel pabs(Pixel x) {</div><div class="line">		<span class="keyword">return</span> Pixel(<span class="built_in">fabs</span>(x.r), <span class="built_in">fabs</span>(x.g), <span class="built_in">fabs</span>(x.b));</div><div class="line">	}</div><div class="line">	<span class="keyword">inline</span> Pixel getPixel(<span class="keyword">int</span> x, <span class="keyword">int</span> y) {</div><div class="line">		<span class="keyword">if</span> (x &gt;= <span class="number">0</span> &amp;&amp; y &gt;= <span class="number">0</span> &amp;&amp; x &lt; H &amp;&amp; y &lt; W)</div><div class="line">			<span class="keyword">return</span> data[x][y];</div><div class="line">		<span class="keyword">if</span> (y &lt; <span class="number">0</span>)	<span class="keyword">return</span> data[min(max(x, <span class="number">0</span>), H-<span class="number">1</span>)][<span class="number">0</span>];</div><div class="line">		<span class="keyword">if</span> (y &gt;= W)	<span class="keyword">return</span> data[min(max(x, <span class="number">0</span>), H-<span class="number">1</span>)][W-<span class="number">1</span>];</div><div class="line">		<span class="keyword">if</span> (x &lt; <span class="number">0</span>)	<span class="keyword">return</span> data[<span class="number">0</span>][min(max(y, <span class="number">0</span>), W-<span class="number">1</span>)];</div><div class="line">		<span class="keyword">if</span> (x &gt;= H)	<span class="keyword">return</span> data[H-<span class="number">1</span>][min(max(y, <span class="number">0</span>), W-<span class="number">1</span>)];</div><div class="line">		<span class="keyword">return</span> Pixel(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">	}</div><div class="line">	<span class="keyword">int</span> sobel(<span class="keyword">int</span> i, <span class="keyword">int</span> j) {</div><div class="line">		<span class="keyword">const</span> <span class="keyword">static</span> <span class="keyword">int</span> dx[] = {-<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>};</div><div class="line">		<span class="keyword">const</span> <span class="keyword">static</span> <span class="keyword">int</span> dy[] = {-<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, -<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, -<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>};</div><div class="line">		<span class="keyword">const</span> <span class="keyword">static</span> <span class="keyword">int</span> xw[] = {-<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, -<span class="number">2</span>, <span class="number">0</span>, <span class="number">2</span>, -<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>};</div><div class="line">		<span class="keyword">const</span> <span class="keyword">static</span> <span class="keyword">int</span> yw[] = {-<span class="number">1</span>, -<span class="number">2</span>, -<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>};				</div><div class="line">		Pixel Dx(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>), Dy(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; <span class="number">9</span>; k++) {</div><div class="line">			<span class="keyword">if</span> (xw[k])</div><div class="line">				Dx = Dx + getPixel(i+dx[k], j+dy[k]) * xw[k];</div><div class="line">			<span class="keyword">if</span> (yw[k])</div><div class="line">				Dy = Dy + getPixel(i+dx[k], j+dy[k]) * yw[k];</div><div class="line">		}</div><div class="line">		<span class="keyword">return</span> Dx.length() + Dy.length();</div><div class="line">	}</div><div class="line">	<span class="keyword">void</span> shrink(<span class="keyword">int</span> n) {</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; H; i++)</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; W; j++)</div><div class="line">				energy[i][j] = sobel(i, j);</div><div class="line">		<span class="keyword">int</span> path[MAXN];</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> it = <span class="number">0</span>; it &lt; n; it++) {</div><div class="line">			shrink(path);</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; H; i++) {</div><div class="line">				<span class="keyword">int</span> y = path[i];</div><div class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> j = y - <span class="number">3</span>; j &lt; W; j++) {</div><div class="line">					<span class="keyword">if</span> (j &gt;= <span class="number">0</span>)</div><div class="line">						energy[i][j] = sobel(i, j);</div><div class="line">				}</div><div class="line">			}</div><div class="line">		}</div><div class="line">	}</div><div class="line">	<span class="keyword">void</span> shrink(<span class="keyword">int</span> path[]) {</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; H; i++) {</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; W; j++) {</div><div class="line">				<span class="keyword">int</span> &amp;val = dp[i][j];</div><div class="line">				<span class="keyword">if</span> (i == <span class="number">0</span>)	val = energy[i][j];</div><div class="line">				<span class="keyword">else</span> {	</div><div class="line">					val = dp[i-<span class="number">1</span>][j];</div><div class="line">					<span class="keyword">if</span> (j-<span class="number">1</span> &gt;= <span class="number">0</span>)</div><div class="line">						val = min(val, dp[i-<span class="number">1</span>][j-<span class="number">1</span>]);</div><div class="line">					<span class="keyword">if</span> (j+<span class="number">1</span> &lt; W)</div><div class="line">						val = min(val, dp[i-<span class="number">1</span>][j+<span class="number">1</span>]);</div><div class="line">					val += energy[i][j];</div><div class="line">				}</div><div class="line">			}</div><div class="line">		}</div><div class="line">		<span class="keyword">int</span> st = <span class="number">0</span>;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; W; i++)</div><div class="line">			<span class="keyword">if</span> (dp[H-<span class="number">1</span>][i] &lt; dp[H-<span class="number">1</span>][st])</div><div class="line">				st = i;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = H-<span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) {</div><div class="line">			path[i] = st;</div><div class="line">			<span class="keyword">int</span> v = dp[i][st] - energy[i][st];</div><div class="line">			<span class="keyword">for</span> (Pixel *p = &amp;data[i][st], *q = &amp;data[i][st+<span class="number">1</span>], *end = &amp;data[i][W]; q != end; p++, q++)</div><div class="line">				*p = *q;</div><div class="line">			<span class="keyword">if</span> (i == <span class="number">0</span>)	<span class="keyword">continue</span>;</div><div class="line">			<span class="keyword">if</span> (st-<span class="number">1</span> &gt;= <span class="number">0</span> &amp;&amp; v == dp[i-<span class="number">1</span>][st-<span class="number">1</span>])</div><div class="line">				st = st-<span class="number">1</span>;</div><div class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (v == dp[i-<span class="number">1</span>][st])</div><div class="line">				st = st;</div><div class="line">			<span class="keyword">else</span></div><div class="line">				st = st+<span class="number">1</span>;</div><div class="line">		}</div><div class="line">		W--;</div><div class="line">	}</div><div class="line">	<span class="keyword">void</span> print() {</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"%d %d\n"</span>, W, H);</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; H; i++)</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; W; j++)</div><div class="line">				data[i][j].print(), <span class="built_in">printf</span>(<span class="string">"%c"</span>, j == W-<span class="number">1</span> ? <span class="string">'\n'</span> : <span class="string">' '</span>);</div><div class="line">	}</div><div class="line">} test;</div><div class="line"><span class="keyword">int</span> main() {</div><div class="line">	<span class="keyword">int</span> n;</div><div class="line">	<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;n);</div><div class="line">	test.read();</div><div class="line">	test.shrink(n);</div><div class="line">	test.print();</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-b442" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/07/11/zj-b442/" class="article-date">
  <time datetime="2015-07-11T13:34:56.000Z" itemprop="datePublished">Jul 11 2015</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>►<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/07/11/zj-b442/">b442. 快取實驗 矩陣乘法</a>
    </h1>
  

      </header>
        
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/07/11/zj-b442/" data-id="qbf3lq7w0qkljl2u" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/07/11/zj-b442/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/作業系統/">作業系統</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem">Problem</h2>
<h3 id="背景">背景</h3>
<p>記得 b439: 快取置換機制 提到的快取置換機制嗎？現在來一場實驗吧！</p>
<h3 id="題目描述">題目描述</h3>
<p>相信不少人都已經實作所謂的矩陣乘法，計算兩個方陣大小為 $N \times N$ 的矩陣 $A, B$。為了方便起見，提供一個偽隨機數的生成，減少在輸入處理浪費的時間，同時也減少上傳測資的辛苦。</p>
<p>根據種子 $c = S1$ 生成矩陣 $A$，種子 $c = S2$ 生成矩陣 $B$，計算矩陣相乘 $A \times B$，為了方便起見，使用 hash 函數進行簽章，最後輸出一個值。由於會牽涉到 overflow 問題，此題作為快取實驗就不考慮這個，overflow 問題大家都會相同。</p>
<p>請利用快取優勢修改代碼如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;bits/stdc++.h&gt;</span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="keyword">class</span> Matrix {</div><div class="line"><span class="keyword">public</span>:</div><div class="line">	<span class="stl_container"><span class="built_in">vector</span>&lt; <span class="stl_container"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;</span> &gt;</span> data;</div><div class="line">	<span class="keyword">int</span> row, col;</div><div class="line">	Matrix(<span class="keyword">int</span> n = <span class="number">1</span>, <span class="keyword">int</span> m = <span class="number">1</span>) {</div><div class="line">		data = <span class="stl_container"><span class="built_in">vector</span>&lt; <span class="stl_container"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;</span> &gt;</span>(n, <span class="stl_container"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;</span>(m, <span class="number">0</span>));</div><div class="line">		row = n, col = m;</div><div class="line">	}</div><div class="line">	<span class="keyword">void</span> rand_gen(<span class="keyword">int</span> c) {</div><div class="line">		<span class="keyword">int</span> x = <span class="number">2</span>, n = row * col;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; row; i++) {</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; col; j++) {</div><div class="line">				x = ((<span class="keyword">long</span> <span class="keyword">long</span>) x * x + c + i + j)%n;</div><div class="line">				data[i][j] = x;</div><div class="line">			}</div><div class="line">		}</div><div class="line">	}</div><div class="line">	Matrix multiply(Matrix x) {</div><div class="line">		Matrix ret(row, x.col);</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; row; i++) {</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; x.col; j++) {</div><div class="line">				<span class="keyword">int</span> sum = <span class="number">0</span>;	<span class="comment">// overflow</span></div><div class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; col; k++)</div><div class="line">					sum += data[i][k] * x.data[k][j];</div><div class="line">				ret.data[i][j] = sum;</div><div class="line">			}</div><div class="line">		}</div><div class="line">		<span class="keyword">return</span> ret;</div><div class="line">	}</div><div class="line">	<span class="keyword">void</span> print() {</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; row; i++) {</div><div class="line">			<span class="built_in">printf</span>(<span class="string">"["</span>);</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; col; j++) {</div><div class="line">				<span class="built_in">printf</span>(<span class="string">" %d"</span>, data[i][j]);</div><div class="line">			}</div><div class="line">			<span class="built_in">printf</span>(<span class="string">" ]\n"</span>);</div><div class="line">		}</div><div class="line">	}</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> signature() {</div><div class="line">		<span class="keyword">unsigned</span> <span class="keyword">long</span> h = <span class="number">0</span>;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; row; i++) {</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; col; j++) {</div><div class="line">				h = hash(h + data[i][j]);</div><div class="line">			}</div><div class="line">		}</div><div class="line">		<span class="keyword">return</span> h;</div><div class="line">	}</div><div class="line"><span class="keyword">private</span>:</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> hash(<span class="keyword">unsigned</span> <span class="keyword">long</span> x) {</div><div class="line">		<span class="keyword">return</span> (x * <span class="number">2654435761L</span>U);</div><div class="line">	}</div><div class="line">};</div><div class="line"><span class="keyword">int</span> main() {</div><div class="line">	<span class="keyword">int</span> N, S1, S2;</div><div class="line">	<span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d %d %d"</span>, &N, &S1, &S2) == <span class="number">3</span>) {</div><div class="line">		Matrix A(N, N), B(N, N), C;</div><div class="line">		A.rand_gen(S1);</div><div class="line">		B.rand_gen(S2);</div><div class="line">		C = A.multiply(B);		</div><div class="line"><span class="comment">//		A.print();</span></div><div class="line"><span class="comment">//		B.print();</span></div><div class="line"><span class="comment">//		C.print();</span></div><div class="line">		<span class="built_in">printf</span>(<span class="string">"%lu\n"</span>, C.signature());</div><div class="line">	}</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<h2 id="Sample_Input">Sample Input</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">2 2 5</div><div class="line">2 2 5</div></pre></td></tr></table></figure>

<h2 id="Sample_Output">Sample Output</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">573770929</div><div class="line">573770929</div></pre></td></tr></table></figure>

<h2 id="Solution">Solution</h2>
<p>在越大的矩陣中，快取記憶體置換是很慢的，即便用 L1, L2, main memory 分層快取，速度差異很明顯，盡可能在線性 $O(n)$ 運算上都不造成記憶體置換 (搬移)，雖然複雜度都是 $O(n^3)$，相信沒人會去實作 $O(n^{2.807})$ 的 Strassen 算法，又或者是現今更快的 Coppersmith-Winograd $O(n^{2.3727})$。</p>
<p>作業系統題目第二彈，考驗快取應用。在 ZJ 主機上速度可以快二十倍，在本機上只快了十倍。</p>
<ol>
<li>蔡神 asas 修改輸入，而我選擇了轉置，速度落後。</li>
<li>柳州 liouzhou_101 同步簽章，而我選擇分開函數，速度落後。</li>
<li>廖氏如神 pcsh710742 下刀計組，等等，我看見了什麼。</li>
</ol>
<p>現在已經快了四十倍，就只是因為編譯器的優化參數變成手動。詳細實作和效能分析，需要的知識不只是作業系統，同時涵蓋計算機組織的 CPU stall 問題，參考 <a href="http://simulationcorner.net/index.php?page=fastmatrixvector" target="_blank" rel="external">Optimizing Large Matrix-Vector Multiplications</a></p>
<p>先來個一般解，在計算矩陣 $A \times B$ 前，先將 $B$ 轉置，接著修改計算方式 </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> <span class="keyword">k</span> = <span class="number">0</span>; <span class="keyword">k</span> &lt; <span class="built_in">col</span>; <span class="keyword">k</span>++) </div><div class="line">    sum += data[<span class="keyword">i</span>][<span class="keyword">k</span>] * <span class="keyword">x</span>.data[<span class="keyword">j</span>][<span class="keyword">k</span>];</div></pre></td></tr></table></figure>

<p>在這一個迴圈中，陣列採用 row-major 的方式儲存，所以第二維度的區域基本上都在快取中，miss 的機會大幅度降低。</p>
<p>接下來要提案的做法是結合上述三位的做法，代碼快，但不能當 Matrix 模板使用，僅僅做為一個效能體現。共用記憶體，採用指針的方式減少複製，一樣進行轉置，但這會破壞原有的 $B$ 矩陣配置。同步進行簽章，捨棄掉 $C$ 矩陣的儲存，使用 LOOP UNROLLING，由於 Zerojudge 的優化沒有開到 <code>-O2</code>、<code>-O3</code>、<code>-Ofast</code>，關於這一部分的優化由使用者自己來。</p>
<p>LOOP UNROLLING 的優化在於 branch 指令，由於 pipeline 會讓效能提升，但遇到 branch 時必須捨棄掉偷偷載入的指令、算到一半的結果，效能會下降，因此使用 LOOP UNROLLING 的好處在於減少 branch 次數。</p>
<p>關於 data prefetch 可以用 <code>__builtin_prefetch()</code> 來完成，根據廖氏如神所言，這個概念可以預先載入防止 stall (pipeline hazard) 的拖延，速度並不會提升太多，有可能是硬體已經完成這一部分，甚至用別的架構去克服。</p>
<h3 id="轉置解">轉置解</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;bits/stdc++.h&gt;</span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="keyword">class</span> Matrix {</div><div class="line"><span class="keyword">public</span>:</div><div class="line">	<span class="stl_container"><span class="built_in">vector</span>&lt; <span class="stl_container"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;</span> &gt;</span> data;</div><div class="line">	<span class="keyword">int</span> row, col;</div><div class="line">	Matrix(<span class="keyword">int</span> n = <span class="number">1</span>, <span class="keyword">int</span> m = <span class="number">1</span>) {</div><div class="line">		data = <span class="stl_container"><span class="built_in">vector</span>&lt; <span class="stl_container"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;</span> &gt;</span>(n, <span class="stl_container"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;</span>(m, <span class="number">0</span>));</div><div class="line">		row = n, col = m;</div><div class="line">	}</div><div class="line">	<span class="keyword">void</span> rand_gen(<span class="keyword">int</span> c) {</div><div class="line">		<span class="keyword">int</span> x = <span class="number">2</span>, n = row * col;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; row; i++) {</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; col; j++) {</div><div class="line">				x = ((<span class="keyword">long</span> <span class="keyword">long</span>) x * x + c + i + j)%n;</div><div class="line">				data[i][j] = x;</div><div class="line">			}</div><div class="line">		}</div><div class="line">	}</div><div class="line">	Matrix multiply(Matrix &amp;x) {</div><div class="line">		Matrix ret(row, x.col);</div><div class="line">		x.transpose();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; row; i++) {</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; x.col; j++) {</div><div class="line">				<span class="keyword">int</span> sum = <span class="number">0</span>;	<span class="comment">// overflow</span></div><div class="line">				<span class="keyword">int</span> *a = &amp;data[i][<span class="number">0</span>], *b = &amp;x.data[j][<span class="number">0</span>];</div><div class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; col; k++)</div><div class="line">					sum += *a * *b, a++, b++;</div><div class="line">				ret.data[i][j] = sum;</div><div class="line">			}</div><div class="line">		}</div><div class="line">		x.transpose();</div><div class="line">		<span class="keyword">return</span> ret;</div><div class="line">	}</div><div class="line">	<span class="keyword">void</span> transpose() {</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; row; i++)</div><div class="line">        	<span class="keyword">for</span> (<span class="keyword">int</span> j = i+<span class="number">1</span>; j &lt; col; j++)</div><div class="line">            	swap(data[i][j], data[j][i]);</div><div class="line">	}</div><div class="line">	<span class="keyword">void</span> print() {</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; row; i++) {</div><div class="line">			<span class="built_in">printf</span>(<span class="string">"["</span>);</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; col; j++)</div><div class="line">				<span class="built_in">printf</span>(<span class="string">" %d"</span>, data[i][j]);</div><div class="line">			<span class="built_in">printf</span>(<span class="string">" ]\n"</span>);</div><div class="line">		}</div><div class="line">	}</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> signature() {</div><div class="line">		<span class="keyword">unsigned</span> <span class="keyword">long</span> h = <span class="number">0</span>;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; row; i++)</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; col; j++)</div><div class="line">				h = hash(h + data[i][j]);</div><div class="line">		<span class="keyword">return</span> h;</div><div class="line">	}</div><div class="line"><span class="keyword">private</span>:</div><div class="line">	<span class="keyword">inline</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> hash(<span class="keyword">unsigned</span> <span class="keyword">long</span> x) {</div><div class="line">		<span class="keyword">return</span> (x * <span class="number">2654435761L</span>U);</div><div class="line">	}</div><div class="line">};</div><div class="line"><span class="keyword">int</span> main() {</div><div class="line">	<span class="keyword">int</span> N, S1, S2;</div><div class="line">	<span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d %d %d"</span>, &amp;N, &amp;S1, &amp;S2) == <span class="number">3</span>) {</div><div class="line">		Matrix A(N, N), B(N, N), C;</div><div class="line">		A.rand_gen(S1);</div><div class="line">		B.rand_gen(S2);</div><div class="line">		C = A.multiply(B);</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"%lu\n"</span>, C.signature());</div><div class="line">	}</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="LOOP_UNROLL_解">LOOP UNROLL 解</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;bits/stdc++.h&gt;</span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="preprocessor">#<span class="keyword">define</span> LOOP_UNROLL 8</span></div><div class="line"><span class="keyword">class</span> Matrix {</div><div class="line"><span class="keyword">public</span>:</div><div class="line">	<span class="stl_container"><span class="built_in">vector</span>&lt; <span class="stl_container"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;</span> &gt;</span> data;</div><div class="line">	<span class="keyword">int</span> row, col;</div><div class="line">	Matrix(<span class="keyword">int</span> n = <span class="number">1</span>, <span class="keyword">int</span> m = <span class="number">1</span>) {</div><div class="line">		row = n, col = m;</div><div class="line">		data = <span class="stl_container"><span class="built_in">vector</span>&lt; <span class="stl_container"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;</span> &gt;</span>(n, <span class="stl_container"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;</span>(m, <span class="number">0</span>));</div><div class="line">	}</div><div class="line">	<span class="keyword">void</span> rand_gen(<span class="keyword">int</span> c) {</div><div class="line">		<span class="keyword">int</span> x = <span class="number">2</span>, n = row * col;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; row; i++) {</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; col; j++) {</div><div class="line">				x = ((<span class="keyword">long</span> <span class="keyword">long</span>) x * x + c + i + j)%n;</div><div class="line">				data[i][j] = x;</div><div class="line">			}</div><div class="line">		}</div><div class="line">	}</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> multiply(Matrix &amp;x) {</div><div class="line">		x.transpose();</div><div class="line">		<span class="keyword">unsigned</span> <span class="keyword">long</span> h = <span class="number">0</span>;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; row; i++) {</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; x.col; j++) {</div><div class="line">				<span class="keyword">register</span> <span class="keyword">int</span> sum = <span class="number">0</span>;</div><div class="line">				<span class="keyword">int</span> *a = &amp;data[i][<span class="number">0</span>], *b = &amp;x.data[j][<span class="number">0</span>], k;</div><div class="line">				<span class="keyword">for</span> (k = <span class="number">0</span>; k+LOOP_UNROLL &lt; col; k += LOOP_UNROLL) {</div><div class="line">					sum += *a * *b, a++, b++;</div><div class="line">					sum += *a * *b, a++, b++;</div><div class="line">					sum += *a * *b, a++, b++;</div><div class="line">					sum += *a * *b, a++, b++;</div><div class="line">					sum += *a * *b, a++, b++;</div><div class="line">					sum += *a * *b, a++, b++;</div><div class="line">					sum += *a * *b, a++, b++;</div><div class="line">					sum += *a * *b, a++, b++;</div><div class="line">				}</div><div class="line">				<span class="keyword">for</span> (; k &lt; col; k++)</div><div class="line">					sum += *a * *b, a++, b++;</div><div class="line">				h = hash(h + sum);</div><div class="line">			}</div><div class="line">		}</div><div class="line">		<span class="keyword">return</span> h;</div><div class="line">	}</div><div class="line">	<span class="keyword">void</span> transpose() {</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; row; i++)</div><div class="line">        	<span class="keyword">for</span> (<span class="keyword">int</span> j = i+<span class="number">1</span>; j &lt; col; j++)</div><div class="line">            	swap(data[i][j], data[j][i]);</div><div class="line">	}</div><div class="line">	<span class="keyword">void</span> print() {</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; row; i++) {</div><div class="line">			<span class="built_in">printf</span>(<span class="string">"["</span>);</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; col; j++)</div><div class="line">				<span class="built_in">printf</span>(<span class="string">" %d"</span>, data[i][j]);</div><div class="line">			<span class="built_in">printf</span>(<span class="string">" ]\n"</span>);</div><div class="line">		}</div><div class="line">	}</div><div class="line"><span class="keyword">private</span>:</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> hash(<span class="keyword">unsigned</span> <span class="keyword">long</span> x) {</div><div class="line">		<span class="keyword">return</span> (x * <span class="number">2654435761L</span>U);</div><div class="line">	}</div><div class="line">} A(<span class="number">1000</span>, <span class="number">1000</span>), B(<span class="number">1000</span>, <span class="number">1000</span>);</div><div class="line"><span class="keyword">int</span> main() {</div><div class="line">	<span class="keyword">int</span> N, S1, S2;</div><div class="line">	<span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d %d %d"</span>, &amp;N, &amp;S1, &amp;S2) == <span class="number">3</span>) {</div><div class="line">		A.row = A.col = B.row = B.col = N;</div><div class="line">		A.rand_gen(S1);</div><div class="line">		B.rand_gen(S2);</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"%lu\n"</span>, A.multiply(B));</div><div class="line">	}</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-b439" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/07/11/zj-b439/" class="article-date">
  <time datetime="2015-07-11T13:21:39.000Z" itemprop="datePublished">Jul 11 2015</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>►<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/07/11/zj-b439/">b439. 快取置換機制</a>
    </h1>
  

      </header>
        
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/07/11/zj-b439/" data-id="fgqloofz97mcol5p" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/07/11/zj-b439/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/作業系統/">作業系統</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem">Problem</h2>
<h3 id="背景">背景</h3>
<p>編寫程式不僅僅是在數學分析上達到高效率，儘管數學分析的複雜度不是最好，理解電腦運作模式也能有效地讓程式變快。例如 資料結構 Unrolled linked list (常翻譯成 塊狀鏈表) 便是利用此一優勢，讓速度顯著地提升，之所以能追上不少常數大的平衡樹操作運用的技巧就是快取效能改善。</p>
<p>講一個更簡單的例子，宣告整數陣列的兩個方案：</p>
<h4 id="方案一">方案一</h4>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> LARGE_SIZE = <span class="number">1</span>&lt;&lt;<span class="number">30</span>;  <span class="keyword">int</span> A[LARGE_SIZE], B[LARGE_SIZE];</div></pre></td></tr></table></figure>

<h4 id="方案二">方案二</h4>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> LARGE_SIZE = <span class="number">1</span>&lt;&lt;<span class="number">30</span>; <span class="keyword">struct</span> DATA { <span class="keyword">int</span> A, B; } E[LARGE_SIZE];</div></pre></td></tr></table></figure>

<p>演算法的複雜度倘若一樣，若在 A, B 相當高頻率的替換，則快取操作必須不斷地將內容置換，若 A, B 在算法中是獨立運算，則方案一的寫法會來得更好，反之取用方案二會比較好。最常見的運作可以在軟體模擬矩陣乘法中見到，預先將矩陣轉置，利用快取優勢速度可以快上 8 倍以上。</p>
<h3 id="問題描述">問題描述</h3>
<p>給予一個記憶體空間大小為 $M$，使用 Least Recently Used (LRU) 策略進行置換，LRU 的策略為將最久沒有被使用過的空間替換掉，也就是需要從硬碟讀取 $disk[i]$ 到 $memory$ 時，發現記憶體都已經用光，則把不常用的 $mem[j]$ 寫入 $disk[k]$，再將 $disk[i]$ 內容寫入 $mem[j]$。</p>
<p>下圖是一個 $M = 4$ 簡單的範例：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">       <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>     <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>     <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>     <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>     <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>     <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>     <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>     <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span></div><div class="line"><span class="comment">mem</span><span class="title">[</span><span class="comment">0</span><span class="title">]</span> <span class="comment">|</span> <span class="comment">1</span> <span class="comment">|</span>     <span class="comment">|</span> <span class="comment">1</span> <span class="comment">|</span>     <span class="comment">|</span> <span class="comment">1</span> <span class="comment">|</span>     <span class="comment">|</span> <span class="comment">1</span> <span class="comment">|</span>     <span class="comment">|</span> <span class="comment">1</span> <span class="comment">|</span>     <span class="comment">|</span> <span class="comment">1</span> <span class="comment">|</span>     <span class="comment">|</span> <span class="comment">1</span> <span class="comment">|</span>     <span class="comment">|</span> <span class="comment">1</span> <span class="comment">|</span></div><div class="line">       <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>     <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>     <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>     <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>     <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>     <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>     <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>     <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span></div><div class="line"><span class="comment">mem</span><span class="title">[</span><span class="comment">1</span><span class="title">]</span> <span class="comment">|</span>   <span class="comment">|</span>     <span class="comment">|</span> <span class="comment">2</span> <span class="comment">|</span>     <span class="comment">|</span> <span class="comment">2</span> <span class="comment">|</span>     <span class="comment">|</span> <span class="comment">2</span> <span class="comment">|</span>     <span class="comment">|</span> <span class="comment">2</span> <span class="comment">|</span>     <span class="comment">|</span> <span class="comment">2</span> <span class="comment">|</span>     <span class="comment">|</span> <span class="comment">2</span> <span class="comment">|</span>     <span class="comment">|</span> <span class="comment">2</span> <span class="comment">|</span></div><div class="line">       <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span> <span class="literal">+</span><span class="literal">-</span>&gt; <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span> <span class="literal">+</span><span class="literal">-</span>&gt; <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span> <span class="literal">+</span><span class="literal">-</span>&gt; <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span> <span class="literal">+</span><span class="literal">-</span>&gt; <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span> <span class="literal">+</span><span class="literal">-</span>&gt; <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span> <span class="literal">+</span><span class="literal">-</span>&gt; <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span> <span class="literal">+</span><span class="literal">-</span>&gt; <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span></div><div class="line"><span class="comment">mem</span><span class="title">[</span><span class="comment">2</span><span class="title">]</span> <span class="comment">|</span>   <span class="comment">|</span>     <span class="comment">|</span>   <span class="comment">|</span>     <span class="comment">|</span> <span class="comment">3</span> <span class="comment">|</span>     <span class="comment">|</span> <span class="comment">3</span> <span class="comment">|</span>     <span class="comment">|</span> <span class="comment">3</span> <span class="comment">|</span>     <span class="comment">|</span> <span class="comment">3</span> <span class="comment">|</span>     <span class="comment">|</span> <span class="comment">5</span> <span class="comment">|</span>     <span class="comment">|</span> <span class="comment">5</span> <span class="comment">|</span></div><div class="line">       <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>     <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>     <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>     <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>     <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>     <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>     <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>     <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span></div><div class="line"><span class="comment">mem</span><span class="title">[</span><span class="comment">3</span><span class="title">]</span> <span class="comment">|</span>   <span class="comment">|</span>     <span class="comment">|</span>   <span class="comment">|</span>     <span class="comment">|</span>   <span class="comment">|</span>     <span class="comment">|</span> <span class="comment">4</span> <span class="comment">|</span>     <span class="comment">|</span> <span class="comment">4</span> <span class="comment">|</span>     <span class="comment">|</span> <span class="comment">4</span> <span class="comment">|</span>     <span class="comment">|</span> <span class="comment">4</span> <span class="comment">|</span>     <span class="comment">|</span> <span class="comment">3</span> <span class="comment">|</span></div><div class="line">       <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>     <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>     <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>     <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>     <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>     <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>     <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>     <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span> </div><div class="line">         <span class="comment">1</span>         <span class="comment">2</span>         <span class="comment">3</span>         <span class="comment">4</span>         <span class="comment">1</span>         <span class="comment">2</span>         <span class="comment">5</span>         <span class="comment">3</span></div></pre></td></tr></table></figure>

<p>依序使用 1, 2, 3, 4, 1, 2, 5, 3 的配置情況，特別是在 5 使用的時候，會將記憶體中上一次最晚使用的 3 替換掉。</p>
<p>現在寫程式去模擬置換情況。</p>
<h2 id="Sample_Input">Sample Input</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">4</div><div class="line"></div><div class="line">0 1</div><div class="line">1 2 514</div><div class="line">1 3 101</div><div class="line">1 4 50216</div><div class="line">0 1</div><div class="line">0 2</div><div class="line">1 5 6</div><div class="line">0 3</div><div class="line">0 5</div><div class="line">0 2</div></pre></td></tr></table></figure>

<h2 id="Sample_Output">Sample Output</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">0 0</div><div class="line">0 0</div><div class="line">1 514</div><div class="line">3 0</div><div class="line">2 6</div><div class="line">1 514</div></pre></td></tr></table></figure>

<h2 id="Solution">Solution</h2>
<p>軟體仿作，使用一個 hash 和一個 list 進行維護，而不是使用 priority queue 來維護，用 list 取代之。當進行取址時，順道把對應 list 指針移動，所有步驟期望複雜度都是在 $O(1)$ 完成，若使用 priority queue 會掉到 $O(\log n)$ 去進行更新。</p>
<p>換出作業系統題目，來一個最常見到的快取 LRU 算法。這個問題在 Leetcode OJ 上面也有，公司面試有機會遇到。</p>
<p>但實作時被自己坑，比較柳柳州給予的測試，速度居然慢個二十多倍。原因是這樣子的</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">map</span>[key] = value;</div><div class="line"><span class="keyword">return</span> <span class="built_in">map</span>.<span class="keyword">find</span>(key);</div></pre></td></tr></table></figure>

<p>替換成以下寫法，速度就起飛了。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> map.insert({key, <span class="keyword">value</span>}).first;</div></pre></td></tr></table></figure>

<p>也就是說插入的時候順便把指針拿到，避免第二次搜索。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;bits/stdc++.h&gt;</span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> pair&lt;<span class="keyword">int</span>, <span class="stl_container"><span class="built_in">list</span>&lt;<span class="keyword">int</span>&gt;</span>::iterator&gt; PIT_TYPE;</div><div class="line"><span class="keyword">typedef</span> <span class="stl_container"><span class="built_in">unordered_map</span>&lt;<span class="keyword">int</span>, pair&lt;<span class="keyword">int</span>, <span class="stl_container"><span class="built_in">list</span>&lt;<span class="keyword">int</span>&gt;</span>::iterator&gt;</span> &gt;::iterator HIT_TYPE;</div><div class="line"><span class="keyword">class</span> LRUCache {</div><div class="line"><span class="keyword">public</span>:	</div><div class="line">	<span class="keyword">int</span> memIdx, size;</div><div class="line">	<span class="stl_container"><span class="built_in">list</span>&lt;<span class="keyword">int</span>&gt;</span> time;</div><div class="line">	<span class="stl_container"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;</span> mem;</div><div class="line">	<span class="stl_container"><span class="built_in">unordered_map</span>&lt;<span class="keyword">int</span>, PIT_TYPE&gt;</span> addr;</div><div class="line">    LRUCache(<span class="keyword">int</span> capacity) {</div><div class="line">    	size = capacity;</div><div class="line">        mem.resize(capacity, <span class="number">0</span>);</div><div class="line">        addr.clear(), time.clear();</div><div class="line">        memIdx = <span class="number">0</span>;</div><div class="line">    }</div><div class="line">    </div><div class="line">    pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; get(<span class="keyword">int</span> key) {</div><div class="line">    	it = addr.find(key);</div><div class="line">        <span class="keyword">if</span> (it == addr.end())</div><div class="line">			it = replace(key), mem[it-&gt;second.first] = <span class="number">0</span>;</div><div class="line">        it-&gt;second.second = recent(it-&gt;second.second);</div><div class="line">        <span class="keyword">return</span> make_pair(it-&gt;second.first, mem[it-&gt;second.first]);</div><div class="line">    }</div><div class="line">    </div><div class="line">    HIT_TYPE <span class="built_in">set</span>(<span class="keyword">int</span> key, <span class="keyword">int</span> value) {</div><div class="line">        it = addr.find(key);</div><div class="line">        <span class="keyword">if</span> (it == addr.end())</div><div class="line">        	it = replace(key);</div><div class="line">        it-&gt;second.second = recent(it-&gt;second.second);</div><div class="line">        mem[it-&gt;second.first] = value;</div><div class="line">        <span class="keyword">return</span> it;</div><div class="line">    }</div><div class="line"><span class="keyword">private</span>:</div><div class="line">	HIT_TYPE it;</div><div class="line">	HIT_TYPE replace(<span class="keyword">int</span> key) {</div><div class="line">		<span class="keyword">int</span> mpos = -<span class="number">1</span>, trash;</div><div class="line">		<span class="stl_container"><span class="built_in">list</span>&lt;<span class="keyword">int</span>&gt;</span>::iterator lpos;</div><div class="line">		<span class="keyword">if</span> (addr.size() == size) {</div><div class="line">			trash = time.front(), time.pop_front();</div><div class="line">			it = addr.find(trash);</div><div class="line">			mpos = it-&gt;second.first;</div><div class="line">			addr.erase(it);</div><div class="line">		} <span class="keyword">else</span> {</div><div class="line">			mpos = memIdx++;</div><div class="line">		}</div><div class="line">		lpos = time.insert(time.end(), key);</div><div class="line">		<span class="keyword">return</span> addr.insert({key, make_pair(mpos, lpos)}).first;</div><div class="line">	}</div><div class="line">	<span class="stl_container"><span class="built_in">list</span>&lt;<span class="keyword">int</span>&gt;</span>::iterator recent(<span class="stl_container"><span class="built_in">list</span>&lt;<span class="keyword">int</span>&gt;</span>::iterator p) {</div><div class="line">		<span class="keyword">int</span> key = *p;</div><div class="line">		time.erase(p);</div><div class="line">		<span class="keyword">return</span> time.insert(time.end(), key);</div><div class="line">	}</div><div class="line">};</div><div class="line"><span class="keyword">int</span> main() {</div><div class="line">	<span class="keyword">int</span> M, cmd, x, y;</div><div class="line">	pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; t;</div><div class="line">	<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;M);</div><div class="line">	</div><div class="line">	LRUCache LL(M);</div><div class="line">	<span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;cmd) == <span class="number">1</span>) {</div><div class="line">		<span class="keyword">if</span> (cmd == <span class="number">0</span>) {</div><div class="line">			<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;x);</div><div class="line">			pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; t = LL.get(x);</div><div class="line">			<span class="built_in">printf</span>(<span class="string">"%d %d\n"</span>, t.first, t.second);</div><div class="line">		} <span class="keyword">else</span> {</div><div class="line">			<span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;x, &amp;y);</div><div class="line">			LL.<span class="built_in">set</span>(x, y);</div><div class="line">		}</div><div class="line">	}</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-b435" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/07/11/zj-b435/" class="article-date">
  <time datetime="2015-07-11T12:59:36.000Z" itemprop="datePublished">Jul 11 2015</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>►<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/07/11/zj-b435/">b435. 尋找原根</a>
    </h1>
  

      </header>
        
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/07/11/zj-b435/" data-id="30acsxpt3ol3ksm7" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/07/11/zj-b435/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/原根/">原根</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/密碼基礎/">密碼基礎</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/數論基礎/">數論基礎</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem">Problem</h2>
<p>給定一個模數 $m$，找到其 primitive root $g$。</p>
<p>primitive root $g$ 滿足</p>
<span>$$g^{\phi(m)} \equiv 1 \mod m \\
g^{\gamma} \not\equiv 1 \mod m \text{ , for } 1 \le \gamma < \phi(m)$$</span>

<p>意即在模 $m$ 下，循環節 $ord_m(g) = \phi(m)$，若 $m$ 是質數，則 $\phi(m) = m-1$，也就是說循環節長度是 $m-1$，更可怕的是組成一個 $[1, m-1]$ 的數字排列。</p>
<p>現在假定 $m$ 是質數，請求出一個最小的 primitive root $g$。</p>
<h2 id="Sample_Input">Sample Input</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">2</div><div class="line">3</div><div class="line">5</div><div class="line">7</div></pre></td></tr></table></figure>

<h2 id="Sample_Output">Sample Output</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">1</div><div class="line">2</div><div class="line">2</div><div class="line">3</div></pre></td></tr></table></figure>

<h2 id="Solution">Solution</h2>
<p>primitive root 在密碼學中，用在 Diffie-Hellman 的選定中的穩定度，倘若基底是一個 primitive root 將會提升破解的難度，因為對應情況大幅增加 (值域比較廣，因為不循環)。</p>
<p>由於歐拉定理，可以得知 $a^{\phi(p)} \equiv 1 \mod p$，那麼可以堆導得到若 $a^x \equiv 1 \mod p$，則滿足 $x | \phi(p)$，否則與歐拉矛盾，藉此可以作為一個篩選的檢查手法，對於所有 $phi(p)$ 的因數都進行檢查，最後我們可以得到 <strong> 一般檢測 </strong> 的作法。</p>
<p>為了加速驗證，由於 $x | \phi(p)$，若最小的 $x$ 存在 $a^x \equiv 1 \mod p$，那麼 $kx$ 也會符合等式，因此只需要檢查 $x = (p-1)/\text{prime-factor}$ 的情況，如此一來速度就快上非常多。最後得到 <strong> 加速版本 </strong>，此做法由 liouzhou_101 提供想法。</p>
<h3 id="一般檢測">一般檢測</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;bits/stdc++.h&gt;</span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="preprocessor">#<span class="keyword">define</span> MAXL (50000&gt;&gt;5)+1</span></div><div class="line"><span class="preprocessor">#<span class="keyword">define</span> GET(x) (mark[(x)&gt;&gt;5]&gt;&gt;((x)&amp;31)&amp;1)</span></div><div class="line"><span class="preprocessor">#<span class="keyword">define</span> SET(x) (mark[(x)&gt;&gt;5] |= 1&lt;&lt;((x)&amp;31))</span></div><div class="line"><span class="keyword">int</span> mark[MAXL];</div><div class="line"><span class="keyword">int</span> P[<span class="number">5500</span>], Pt = <span class="number">0</span>;</div><div class="line"><span class="keyword">void</span> sieve() {</div><div class="line">    <span class="keyword">register</span> <span class="keyword">int</span> i, j, k;</div><div class="line">    SET(<span class="number">1</span>);</div><div class="line">    <span class="keyword">int</span> n = <span class="number">45825</span>;</div><div class="line">    <span class="keyword">for</span>(i = <span class="number">2</span>; i &lt;= n; i++) {</div><div class="line">        <span class="keyword">if</span>(!GET(i)) {</div><div class="line">            <span class="keyword">for</span>(k = n/i, j = i*k; k &gt;= i; k--, j -= i)</div><div class="line">                SET(j);</div><div class="line">            P[Pt++] = i;</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"><span class="stl_container"><span class="built_in">vector</span>&lt; pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt;</span> &gt; factor(<span class="keyword">int</span> n) {</div><div class="line">	<span class="stl_container"><span class="built_in">vector</span>&lt; pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt;</span> &gt; R;</div><div class="line">	</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>, j; i &lt; Pt &amp;&amp; P[i] * P[i] &lt;= n; i++) {</div><div class="line">		<span class="keyword">if</span>(n%P[i] == <span class="number">0</span>) {</div><div class="line">			<span class="keyword">for</span>(j = <span class="number">0</span>; n%P[i] == <span class="number">0</span>; n /= P[i], j++);</div><div class="line">			R.push_back(make_pair(P[i], j));</div><div class="line">		}</div><div class="line">	}</div><div class="line">	<span class="keyword">if</span>(n != <span class="number">1</span>)	R.push_back(make_pair(n, <span class="number">1</span>));</div><div class="line">	<span class="keyword">return</span> R;</div><div class="line">}</div><div class="line"><span class="keyword">void</span> gen_factor(<span class="keyword">int</span> idx, <span class="keyword">int</span> x, <span class="stl_container"><span class="built_in">vector</span>&lt; pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt;</span> &gt; &amp;f, <span class="stl_container"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;</span> &amp;g) {</div><div class="line">	<span class="keyword">if</span> (idx == f.size()) {</div><div class="line">		g.push_back(x);</div><div class="line">		<span class="keyword">return</span> ;</div><div class="line">	}</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, a = <span class="number">1</span>; i &lt;= f[idx].second; i++, a *= f[idx].first) </div><div class="line">		gen_factor(idx+<span class="number">1</span>, x*a, f, g);</div><div class="line">}</div><div class="line"><span class="keyword">long</span> <span class="keyword">long</span> mpow(<span class="keyword">long</span> <span class="keyword">long</span> x, <span class="keyword">long</span> <span class="keyword">long</span> y, <span class="keyword">long</span> <span class="keyword">long</span> mod) {</div><div class="line">	<span class="keyword">long</span> <span class="keyword">long</span> ret = <span class="number">1</span>;</div><div class="line">	<span class="keyword">while</span> (y) {</div><div class="line">		<span class="keyword">if</span> (y&amp;<span class="number">1</span>) </div><div class="line">			ret = (ret * x)%mod;</div><div class="line">		y &gt;&gt;= <span class="number">1</span>, x = (x * x)%mod;</div><div class="line">	}</div><div class="line">	<span class="keyword">return</span> ret % mod;</div><div class="line">}</div><div class="line"><span class="keyword">int</span> primitive_root(<span class="keyword">int</span> p) {</div><div class="line">	<span class="keyword">if</span> (p == <span class="number">2</span>)	<span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">	<span class="stl_container"><span class="built_in">vector</span>&lt; pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt;</span> &gt; f = factor(p-<span class="number">1</span>);</div><div class="line">	<span class="stl_container"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;</span> g;</div><div class="line">	gen_factor(<span class="number">0</span>, <span class="number">1</span>, f, g);</div><div class="line">	g.erase(g.begin()), g.pop_back();	<span class="comment">// remove 1, p-1</span></div><div class="line">	random_shuffle(g.begin(), g.end());</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; i &lt;= p; i++) {</div><div class="line">		<span class="keyword">int</span> ok = <span class="number">1</span>;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">auto</span> &amp;x: g) {</div><div class="line">			<span class="keyword">if</span> (mpow(i, x, p) == <span class="number">1</span>) {</div><div class="line">				ok = <span class="number">0</span>;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			}</div><div class="line">		}</div><div class="line">		<span class="keyword">if</span> (ok)	<span class="keyword">return</span> i;</div><div class="line">	}</div><div class="line">	<span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">}</div><div class="line"><span class="keyword">int</span> main() {</div><div class="line">	sieve();</div><div class="line">	<span class="keyword">int</span> p;</div><div class="line">	<span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;p) == <span class="number">1</span>) </div><div class="line">		<span class="built_in">printf</span>(<span class="string">"%d\n"</span>, primitive_root(p));</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="加速版本">加速版本</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;bits/stdc++.h&gt;</span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="preprocessor">#<span class="keyword">define</span> MAXL (50000&gt;&gt;5)+1</span></div><div class="line"><span class="preprocessor">#<span class="keyword">define</span> GET(x) (mark[(x)&gt;&gt;5]&gt;&gt;((x)&amp;31)&amp;1)</span></div><div class="line"><span class="preprocessor">#<span class="keyword">define</span> SET(x) (mark[(x)&gt;&gt;5] |= 1&lt;&lt;((x)&amp;31))</span></div><div class="line"><span class="keyword">int</span> mark[MAXL];</div><div class="line"><span class="keyword">int</span> P[<span class="number">5500</span>], Pt = <span class="number">0</span>;</div><div class="line"><span class="keyword">void</span> sieve() {</div><div class="line">    <span class="keyword">register</span> <span class="keyword">int</span> i, j, k;</div><div class="line">    SET(<span class="number">1</span>);</div><div class="line">    <span class="keyword">int</span> n = <span class="number">45825</span>;</div><div class="line">    <span class="keyword">for</span>(i = <span class="number">2</span>; i &lt;= n; i++) {</div><div class="line">        <span class="keyword">if</span>(!GET(i)) {</div><div class="line">            <span class="keyword">for</span>(k = n/i, j = i*k; k &gt;= i; k--, j -= i)</div><div class="line">                SET(j);</div><div class="line">            P[Pt++] = i;</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"><span class="stl_container"><span class="built_in">vector</span>&lt; pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt;</span> &gt; factor(<span class="keyword">int</span> n) {</div><div class="line">	<span class="stl_container"><span class="built_in">vector</span>&lt; pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt;</span> &gt; R;</div><div class="line">	</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>, j; i &lt; Pt &amp;&amp; P[i] * P[i] &lt;= n; i++) {</div><div class="line">		<span class="keyword">if</span>(n%P[i] == <span class="number">0</span>) {</div><div class="line">			<span class="keyword">for</span>(j = <span class="number">0</span>; n%P[i] == <span class="number">0</span>; n /= P[i], j++);</div><div class="line">			R.push_back(make_pair(P[i], j));</div><div class="line">		}</div><div class="line">	}</div><div class="line">	<span class="keyword">if</span>(n != <span class="number">1</span>)	R.push_back(make_pair(n, <span class="number">1</span>));</div><div class="line">	<span class="keyword">return</span> R;</div><div class="line">}</div><div class="line"><span class="keyword">long</span> <span class="keyword">long</span> mpow(<span class="keyword">long</span> <span class="keyword">long</span> x, <span class="keyword">long</span> <span class="keyword">long</span> y, <span class="keyword">long</span> <span class="keyword">long</span> mod) {</div><div class="line">	<span class="keyword">long</span> <span class="keyword">long</span> ret = <span class="number">1</span>;</div><div class="line">	<span class="keyword">while</span> (y) {</div><div class="line">		<span class="keyword">if</span> (y&amp;<span class="number">1</span>) </div><div class="line">			ret = (ret * x)%mod;</div><div class="line">		y &gt;&gt;= <span class="number">1</span>, x = (x * x)%mod;</div><div class="line">	}</div><div class="line">	<span class="keyword">return</span> ret % mod;</div><div class="line">}</div><div class="line"><span class="keyword">int</span> primitive_root(<span class="keyword">int</span> p) {</div><div class="line">	<span class="keyword">if</span> (p == <span class="number">2</span>)	<span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">	<span class="stl_container"><span class="built_in">vector</span>&lt; pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt;</span> &gt; f = factor(p-<span class="number">1</span>);</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; i &lt;= p; i++) {</div><div class="line">		<span class="keyword">int</span> ok = <span class="number">1</span>;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">auto</span> &amp;x: f) {</div><div class="line">			<span class="keyword">if</span> (mpow(i, (p-<span class="number">1</span>)/x.first, p) == <span class="number">1</span>) {</div><div class="line">				ok = <span class="number">0</span>;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			}</div><div class="line">		}</div><div class="line">		<span class="keyword">if</span> (ok)	<span class="keyword">return</span> i;</div><div class="line">	}</div><div class="line">	<span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">}</div><div class="line"><span class="keyword">int</span> main() {</div><div class="line">	sieve();</div><div class="line">	<span class="keyword">int</span> p;</div><div class="line">	<span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;p) == <span class="number">1</span>) </div><div class="line">		<span class="built_in">printf</span>(<span class="string">"%d\n"</span>, primitive_root(p));</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-b432" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/07/10/zj-b432/" class="article-date">
  <time datetime="2015-07-10T11:40:06.000Z" itemprop="datePublished">Jul 10 2015</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>►<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/07/10/zj-b432/">b432. 趣味加分</a>
    </h1>
  

      </header>
        
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/07/10/zj-b432/" data-id="wwmjwimddsee5iu8" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/07/10/zj-b432/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/數論基礎/">數論基礎</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem">Problem</h2>
<h3 id="背景">背景</h3>
<p>廖氏如神 (pcsh710742) 在作業中遇到一題，用手算會算到天昏地暗，而問題是這樣子的：</p>
<span>$$a^{13337} \equiv n \mod 2^{64}$$</span>

<p>其中 $n= 2015 + 2 \times (\text{The last 2 digit of your student ID number})$，請找到 $a &lt; 2^{64}$ 的其中一組解。</p>
<h3 id="問題描述">問題描述</h3>
<p>模數 $2^{64}$ 看起來不大，但對於 Ghz 為 CPU 運算速度單位的電腦而言還是要跑非常久的。因此將問題簡化：</p>
<span>$$a^{23333} \equiv n \mod 2^{20}$$</span>

<p>現在給予一個 $n$，請求出一組 $a$，測資中保證答案唯一。</p>
<h2 id="Sample_Input">Sample Input</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">268275</div><div class="line">888817</div><div class="line">89215</div><div class="line">63495</div><div class="line">976477</div></pre></td></tr></table></figure>

<h2 id="Sample_Output">Sample Output</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">387</div><div class="line">817</div><div class="line">639</div><div class="line">487</div><div class="line">909</div></pre></td></tr></table></figure>

<h2 id="Solution">Solution</h2>
<p>除了偶數無解外，奇數都至少有一個解。而這一題的題目數據恰好奇數都只有一解，那麼就不必處理多組解或者是字典順序最小的，只要專心找到符合的解即可。</p>
<ul>
<li>暴力建表 $O(2^{20})$ 建完，之後直接查找。</li>
<li>篩選正解，依序窮舉從最低位到最高位 (二進制下) 為 0 還是 1，由於次方會不斷地推移，高位結果不影響低位的對應。窮舉時保留低位符合的解，並且不斷地篩選掉不可能的解方案，複雜度 $O(20 k)$，$k$ 是難以估計的數字。</li>
<li>快速假解，類似篩選正解的做法，但只保留其中一組解進行，複雜度 $O(20)$。這個解法是有點毛病的，但目前找不到反例。</li>
</ul>
<h3 id="快速假解">快速假解</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;bits/stdc++.h&gt; </span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="keyword">long</span> <span class="keyword">long</span> mul(<span class="keyword">long</span> <span class="keyword">long</span> a, <span class="keyword">long</span> <span class="keyword">long</span> b, <span class="keyword">long</span> <span class="keyword">long</span> mod) { </div><div class="line">	<span class="keyword">long</span> <span class="keyword">long</span> ret = <span class="number">0</span>; </div><div class="line">	<span class="keyword">for</span> (a %= mod, b %= mod; b != <span class="number">0</span>; b&gt;&gt;=<span class="number">1</span>, a &lt;&lt;= <span class="number">1</span>, a = a &gt;= mod ? a - mod : a) { </div><div class="line">		<span class="keyword">if</span> (b&amp;<span class="number">1</span>) {</div><div class="line">			ret += a;</div><div class="line">			<span class="keyword">if</span> (ret &gt;= mod)	ret -= mod;</div><div class="line">		} </div><div class="line">	} </div><div class="line">	<span class="keyword">return</span> ret; </div><div class="line">}</div><div class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> mpow(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> x, <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> y, <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> mod) {</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> ret = <span class="number">1</span>;</div><div class="line">	<span class="keyword">while</span> (y) {</div><div class="line">		<span class="keyword">if</span> (y&amp;<span class="number">1</span>) </div><div class="line">			ret = (ret * x)%mod;</div><div class="line">		y &gt;&gt;= <span class="number">1</span>, x = (x * x)%mod;</div><div class="line">	}</div><div class="line">	<span class="keyword">return</span> ret % mod;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// find a^23333 = n \mod 2^32</span></div><div class="line"><span class="keyword">int</span> main() {</div><div class="line">	<span class="keyword">const</span> <span class="keyword">long</span> <span class="keyword">long</span> M = <span class="number">1L</span>L&lt;&lt;<span class="number">20</span>;</div><div class="line">	<span class="keyword">const</span> <span class="keyword">long</span> <span class="keyword">long</span> E = <span class="number">23333</span>;</div><div class="line">	<span class="keyword">long</span> <span class="keyword">long</span> n;</div><div class="line">	<span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%lld"</span>, &amp;n) == <span class="number">1</span>) {</div><div class="line">		<span class="keyword">long</span> <span class="keyword">long</span> a = <span class="number">0</span>;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">32</span>; i++) {</div><div class="line">			<span class="keyword">long</span> <span class="keyword">long</span> t = mpow(a, E, M), mask = (<span class="number">1L</span>L&lt;&lt;(i+<span class="number">1</span>))-<span class="number">1</span>;</div><div class="line">			<span class="keyword">if</span> ((t&amp;mask) == (n&amp;mask)) {</div><div class="line">				</div><div class="line">			} <span class="keyword">else</span> {</div><div class="line">				a |= <span class="number">1L</span>L&lt;&lt;i;</div><div class="line">			}			</div><div class="line">		}</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"%lld\n"</span>, a);</div><div class="line">	}</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="篩選正解">篩選正解</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;bits/stdc++.h&gt; </span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> mpow(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> x, <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> y, <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> mod) {</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> ret = <span class="number">1</span>;</div><div class="line">	<span class="keyword">while</span> (y) {</div><div class="line">		<span class="keyword">if</span> (y&amp;<span class="number">1</span>) </div><div class="line">			ret = (ret * x)%mod;</div><div class="line">		y &gt;&gt;= <span class="number">1</span>, x = (x * x)%mod;</div><div class="line">	}</div><div class="line">	<span class="keyword">return</span> ret % mod;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// find a^23333 = n \mod 2^32</span></div><div class="line"><span class="keyword">int</span> main() {</div><div class="line">	<span class="keyword">const</span> <span class="keyword">long</span> <span class="keyword">long</span> M = <span class="number">1L</span>L&lt;&lt;<span class="number">20</span>;</div><div class="line">	<span class="keyword">const</span> <span class="keyword">long</span> <span class="keyword">long</span> E = <span class="number">23333</span>;</div><div class="line">	<span class="keyword">long</span> <span class="keyword">long</span> n;</div><div class="line">	<span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%lld"</span>, &amp;n) == <span class="number">1</span>) {</div><div class="line">		<span class="stl_container"><span class="built_in">vector</span>&lt;<span class="keyword">long</span> <span class="keyword">long</span>&gt;</span> A(<span class="number">1</span>, <span class="number">0</span>);</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) {</div><div class="line">			<span class="stl_container"><span class="built_in">vector</span>&lt;<span class="keyword">long</span> <span class="keyword">long</span>&gt;</span> nA;</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">auto</span> &amp;a : A) {</div><div class="line">				<span class="keyword">long</span> <span class="keyword">long</span> t, mask;</div><div class="line">				t = mpow(a, E, M), mask = (<span class="number">1L</span>L&lt;&lt;(i+<span class="number">1</span>))-<span class="number">1</span>;</div><div class="line">				<span class="keyword">if</span> ((t&amp;mask) == (n&amp;mask)) {</div><div class="line">					nA.push_back(a);</div><div class="line">				} </div><div class="line">				t = mpow(a|(<span class="number">1L</span>L&lt;&lt;i), E, M), mask = (<span class="number">1L</span>L&lt;&lt;(i+<span class="number">1</span>))-<span class="number">1</span>;</div><div class="line">				<span class="keyword">if</span> ((t&amp;mask) == (n&amp;mask)) {</div><div class="line">					nA.push_back(a|(<span class="number">1L</span>L&lt;&lt;i));</div><div class="line">				}			</div><div class="line">			}</div><div class="line">			A = nA;</div><div class="line">		}</div><div class="line">		assert(A.size() &gt; <span class="number">0</span> &amp;&amp; mpow(A[<span class="number">0</span>], E, M) == n);</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"%lld\n"</span>, A[<span class="number">0</span>]);</div><div class="line">	}</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/categories/解題區/解題區-Zerojudge/page/2/">2</a><a class="page-number" href="/categories/解題區/解題區-Zerojudge/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/categories/解題區/解題區-Zerojudge/page/5/">5</a><a class="extend next" rel="next" href="/categories/解題區/解題區-Zerojudge/page/2/">Next &raquo;</a>
    </nav>
  
</section>
          
            <aside id="sidebar">
  <div id="ukagaka_panel"></div>
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/">學校課程</a><span class="category-list-count">63</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/介面設計/">介面設計</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/作業系統/">作業系統</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/大學專題/">大學專題</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/巨量資料/">巨量資料</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/敏捷方法/">敏捷方法</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/編譯器/">編譯器</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/自然語言/">自然語言</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/虛擬實境/">虛擬實境</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算型智慧/">計算型智慧</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算幾何/">計算幾何</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/資料庫系統/">資料庫系統</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/資訊安全/">資訊安全</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/通識課程/">通識課程</a><span class="category-list-count">14</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/手札日記/">手札日記</a><span class="category-list-count">24</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/">網頁設計</a><span class="category-list-count">14</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/About-This-Blog/">About This Blog</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/HTML5/">HTML5</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/JQuery/">JQuery</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/Markdown/">Markdown</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/NodeJs/">NodeJs</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/">解題區</a><span class="category-list-count">552</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/Latex/">Latex</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/出題解題/">出題解題</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-POJ/">解題區 - POJ</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-UVa/">解題區 - UVa</a><span class="category-list-count">453</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a><span class="category-list-count">50</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-其他題目/">解題區 - 其他題目</a><span class="category-list-count">28</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-未解題目/">解題區 - 未解題目</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/雜言筆記/">雜言筆記</a><span class="category-list-count">4</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a class="text" href="/2015/07/15/zj-b446/">
              
                <i class="icon-file-o"></i> 
              
            b446. 搜索美學 史蒂芙的煩惱</a>
          </li>
        
          <li>
            <a class="text" href="/2015/07/15/zj-b443/">
              
                <i class="icon-file-o"></i> 
              
            b443. 我愛 Fibonacci</a>
          </li>
        
          <li>
            <a class="text" href="/2015/07/13/zj-b444/">
              
                <i class="icon-file-o"></i> 
              
            b444. 期望試驗 快速冪次</a>
          </li>
        
          <li>
            <a class="text" href="/2015/07/12/diary-20150712/">
              
                <i class="icon-file-o"></i> 
              
            在醒不來的夢中探索</a>
          </li>
        
          <li>
            <a class="text" href="/2015/07/12/zj-b440/">
              
                <i class="icon-file-o"></i> 
              
            b440. 互質對</a>
          </li>
        
          <li>
            <a class="text" href="/2015/07/12/zj-b441/">
              
                <i class="icon-file-o"></i> 
              
            b441. 延展尺寸</a>
          </li>
        
          <li>
            <a class="text" href="/2015/07/12/zj-b438/">
              
                <i class="icon-file-o"></i> 
              
            b438. 裁剪尺寸</a>
          </li>
        
          <li>
            <a class="text" href="/2015/07/11/zj-b442/">
              
                <i class="icon-file-o"></i> 
              
            b442. 快取實驗 矩陣乘法</a>
          </li>
        
          <li>
            <a class="text" href="/2015/07/11/zj-b439/">
              
                <i class="icon-file-o"></i> 
              
            b439. 快取置換機制</a>
          </li>
        
          <li>
            <a class="text" href="/2015/07/11/zj-b435/">
              
                <i class="icon-file-o"></i> 
              
            b435. 尋找原根</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    <div class="widget-wrap">
    <h3 class="widget-title">Links</h3>
    <div class="widget">   
      	<ul>
	      <li><a href="http://mypaper.pchome.com.tw/zerojudge" target="_blank" title="Old Blog"><i class="icon-star"></i> Morris' Blog (pchome)</a></li>
	      <li><a href="http://flere114.blogspot.tw/" target="_blank" title="蘿莉勿觸"><i class="icon-googles"></i> flere's Blog</a></li>
	      <li><a href="http://dreamoon4.blogspot.tw/" target="_blank" title="夢月"><i class="icon-googles"></i> dreamoon's Blog</a></li>
	      <li><a href="http://m80126colin.github.io" target="_blank" title="許胖們"><i class="icon-github-alt"></i> m80126colin's Blog</a></li>
	      <li><a href="http://sd12582000.blogspot.tw/" target="_blank" title="妮可妮可"><i class="icon-github-alt"></i> Nico's Blog</a></li>
	      <li><a href="http://kuoe0.logdown.com/" target="_blank" title="郭至軒大神"><i class="icon-github-alt"></i> KuoE0's Dots</a></li>
	      <li><a href="http://tyan.io/" title=""><i class="icon-github-alt"></i> Tyan Blog</a></li>
    	</ul>
    </div>
</div>

  
    
<script src="/js/jquery-ui.js"></script>
<script src="/js/ukagaka/jquery.morris.ukagaka.resource.js"></script>
<script src="/js/ukagaka/typed.js"></script>
<script type="text/javascript">
  $('#ukagaka_panel').ukagaka();
</script>
  
</aside>
          
        
      </div>
      <footer id="footer">
  
  <div class="outer">    
    <div class="social-group">
      
      <a href="https://github.com/morris821028" target="_blank" title="github"><i class="icon-github"></i></a>
      
      
      <a href="https://plus.google.com/u/0/108158678174364359204" target="_blank" title="Google+"><i class="icon-google-plus-sign"></i></a>
      
      
      <a href="https://www.facebook.com/Morris1028" target="_blank" title="facebook"><i class="icon-facebook-sign"></i></a>
      
      
      <a href="http://uhunt.felix-halim.net/id/46705" target="_blank" title="uhunt" ><span class="icon-uhunt">UVa<span></a>
      
    </div>
    <div id="footer-info" class="inner">
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and Theme by <a href="https://github.com/morris821028/hexo-theme-landscape" target="_blank" title="landscape">landscape</a> &copy; 2015 Shiang-Yun Yang 
    </div>  

  </div>
</footer>


    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link"><i class=icon-home ></i>&nbsp&nbspHome</a>
  
    <a href="/about" class="mobile-nav-link"><i class=icon-user ></i>&nbsp&nbspAbout</a>
  
    <a href="/archives" class="mobile-nav-link"><i class=icon-archive ></i>&nbsp&nbspArchives</a>
  
    <a href="/tags" class="mobile-nav-link"><i class=icon-tags ></i>&nbsp&nbspTags</a>
  
    <a href="/picture" class="mobile-nav-link"><i class=icon-camera ></i>&nbsp&nbspPictures</a>
  
    <a href="/works" class="mobile-nav-link"><i class=icon-trophy ></i>&nbsp&nbspWorks</a>
  
</nav>
    
<script>
  var disqus_shortname = 'morris1028';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//go.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">

  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>



<script src="/js/jquery.lazyload.js" type="text/javascript"></script>

<script src="/js/jquery.als-1.6.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>


  </div>
</body>
</html>